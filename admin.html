<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… v9.0 - Ù†Ø¸ÙŠÙØ© ÙˆÙ…Ø­Ø³Ù‘Ù†Ø©</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        h2 { color: #1a73e8; border-bottom: 3px solid #1a73e8; padding-bottom: 15px; margin-bottom: 25px; font-size: 24px; }
        
        /* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-box { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .stat-box:nth-child(2) { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-box:nth-child(3) { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-num { font-size: 42px; font-weight: bold; display: block; margin-bottom: 5px; }
        .stat-label { font-size: 14px; opacity: 0.9; }
        
        /* Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ */
        textarea { width: 100%; height: 140px; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 15px; resize: vertical; font-family: inherit; }
        textarea:focus { outline: none; border-color: #1a73e8; }
        
        .btn { border: none; padding: 15px 30px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s; width: 100%; margin-top: 15px; }
        .btn-primary { background: #1a73e8; color: white; }
        .btn-primary:hover { background: #0d47a1; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(26,115,232,0.3); }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… */
        .progress { width: 100%; height: 30px; background: #e0e0e0; border-radius: 15px; overflow: hidden; margin: 15px 0; display: none; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #1a73e8, #28a745); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; }
        
        #status { text-align: center; margin: 15px 0; font-weight: bold; font-size: 16px; min-height: 24px; }
        
        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        .tables { display: grid; gap: 25px; margin-top: 30px; }
        .table-section { background: #f8f9fa; border-radius: 10px; overflow: hidden; border: 2px solid #e9ecef; }
        .table-header { padding: 15px; font-weight: bold; font-size: 16px; color: white; }
        .header-matches { background: #28a745; }
        .header-public { background: #17a2b8; }
        
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #f8f9fa; padding: 12px; text-align: right; font-weight: 600; border-bottom: 2px solid #dee2e6; }
        td { padding: 12px; border-bottom: 1px solid #e9ecef; }
        tr:hover { background: #f8f9fa; }
        .match-row { background: #fff3cd; border-right: 4px solid #ffc107; }
        .phone-owner { color: #dc3545; font-weight: 600; }
        .phone-finder { color: #007bff; font-weight: 600; }
        .empty-state { text-align: center; padding: 40px; color: #6c757d; font-size: 14px; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
        .modal-content { background: white; margin: 10% auto; padding: 30px; border-radius: 15px; max-width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: slideDown 0.3s; }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal h3 { color: #1a73e8; margin-bottom: 20px; font-size: 20px; }
        .modal select { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 15px; }
        .modal button { width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 8px; font-size: 15px; font-weight: bold; cursor: pointer; }
        .modal .btn-save { background: #28a745; color: white; }
        .modal .btn-skip { background: #6c757d; color: white; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸš€ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù†Ø³Ø®Ø© Ù†Ø¸ÙŠÙØ© ÙˆÙ…Ø­Ø³Ù‘Ù†Ø© v9.0</h2>

    <div class="stats">
        <div class="stat-box">
            <span class="stat-num" id="statFound">0</span>
            <span class="stat-label">Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</span>
        </div>
        <div class="stat-box">
            <span class="stat-num" id="statMissing">0</span>
            <span class="stat-label">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¨Ø­Ø«</span>
        </div>
        <div class="stat-box">
            <span class="stat-num" id="statSpeed">--</span>
            <span class="stat-label">Ø³Ø±Ø¹Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</span>
        </div>
    </div>
    
    <textarea id="dataInput" placeholder="Ø§Ù„ØµÙ‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ù‡Ù†Ø§...&#10;&#10;Ù…Ø«Ø§Ù„:&#10;ÙƒÙˆØ±ÙˆÙ„Ø§ Ø´Ø§Ø³ÙŠ 1234&#10;ÙƒØ§Ù…Ø±ÙŠ Ø´Ø§Ø³ÙŠ 5678"></textarea>
    
    <button class="btn btn-primary" id="uploadBtn" onclick="processData()">âš¡ Ø±ÙØ¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
    
    <div class="progress" id="progress">
        <div class="progress-bar" id="progressBar">0%</div>
    </div>
    
    <div id="status"></div>
    
    <button class="btn btn-danger" onclick="deleteAllData()">ğŸ—‘ï¸ Ù…Ø³Ø­ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>

    <div class="tables">
        <div class="table-section">
            <div class="table-header header-matches">âœ¨ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ©</div>
            <table>
                <thead><tr><th>Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø§Ù„Ùƒ</th><th>Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th></tr></thead>
                <tbody id="matchesTable"></tbody>
            </table>
        </div>

        <div class="table-section">
            <div class="table-header header-public">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</div>
            <table>
                <thead><tr><th>Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø§Ù„Ùƒ</th><th>Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead>
                <tbody id="publicTable"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Ù„Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
<div id="modelModal" class="modal">
    <div class="modal-content">
        <h3>ğŸš— Ù…ÙˆØ¯ÙŠÙ„ Ø¬Ø¯ÙŠØ¯: <span id="modelName"></span></h3>
        <p>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©:</p>
        <select id="brandSelect"></select>
        <button class="btn-save" onclick="saveModel()">Ø­ÙØ¸</button>
        <button class="btn-skip" onclick="skipModel()">ØªØ¬Ø§Ù‡Ù„</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Firebase Configuration
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig = {
    apiKey: "AIzaSyDvAx6-priGfzGLh2AlazSkIvsoc0OcW4Q",
    authDomain: "sudancarsrecover.firebaseapp.com",
    projectId: "sudancarsrecover",
    storageBucket: "sudancarsrecover.firebasestorage.app",
    messagingSenderId: "222129422162",
    appId: "1:222129422162:web:c3e8d3c498b53f96afc48b"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Car Models Database
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const carModels = {
    "ÙƒÙˆØ±ÙˆÙ„Ø§": "ØªÙˆÙŠÙˆØªØ§", "Ù…ÙˆÙ†ÙƒØ§": "ØªÙˆÙŠÙˆØªØ§", "ÙƒØ§Ù…Ø±ÙŠ": "ØªÙˆÙŠÙˆØªØ§", "Ù„Ø§Ù†Ø¯ÙƒØ±ÙˆØ²Ø±": "ØªÙˆÙŠÙˆØªØ§", "ÙƒØ±ÙˆØ²Ø±": "ØªÙˆÙŠÙˆØªØ§",
    "Ø¨Ø±Ø§Ø¯Ùˆ": "ØªÙˆÙŠÙˆØªØ§", "ÙÙˆØ±Ø´Ù†Ø±": "ØªÙˆÙŠÙˆØªØ§", "Ù‡Ø§ÙŠÙ„ÙˆÙƒØ³": "ØªÙˆÙŠÙˆØªØ§", "Ø¨ÙˆÙƒØ³ÙŠ": "ØªÙˆÙŠÙˆØªØ§", "ÙŠØ§Ø±Ø³": "ØªÙˆÙŠÙˆØªØ§",
    "Ù‡Ø§ÙŠØ³": "ØªÙˆÙŠÙˆØªØ§", "Ø´Ø±ÙŠØ­Ø©": "ØªÙˆÙŠÙˆØªØ§", "Ø±Ø§Ù": "ØªÙˆÙŠÙˆØªØ§", "ÙƒÙˆØ³ØªØ±": "ØªÙˆÙŠÙˆØªØ§",
    
    "Ø§ÙƒØ³Ù†Øª": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ù…Ø¶Ù„Ø¹": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø¯Ø¨Ø¯ÙˆØ¨": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø¬ÙŠØ§Ø¯": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø£ÙØ§Ù†ØªÙŠ": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ",
    "Ø§ÙØ§Ù†ØªÙŠ": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø³Ø­Ù„ÙŠØ©": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ù…Ù†ÙÙˆØ®Ø©": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "ÙÙŠØ±Ù†Ø§": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø§ÙŠ ØªÙ†": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ",
    "Ø·ÙŠÙˆØ± Ø§Ù„Ø¬Ù†Ø©": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "ÙƒÙ„Ùƒ": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ù‚ÙŠØªØ²": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "ØªÙˆØ³Ø§Ù†": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø³Ù†ØªØ§ÙÙŠ": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ",
    "Ø³ÙˆÙ†Ø§ØªØ§": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø¥Ù„Ù†ØªØ±Ø§": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø§Ù„Ù†ØªØ±Ø§": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø³ØªØ§Ø±ÙŠÙƒØ³": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø§ØªØ´ ÙˆÙ†": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ",
    "Ø¬Ø±ÙŠØ³": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "ÙƒØ±ÙŠØ²": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø§ÙŠÙˆÙ†": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ù…Ø§ØªØ±ÙƒØ³": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ù„Ø§ÙÙŠØªØ§": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ",
    "Ø¨ÙˆØ±ØªØ± Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø§ØªÙˆØ³": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø§ØªØ³": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ",
    
    "Ù…ÙˆØ±Ù†ÙŠÙ‚": "ÙƒÙŠØ§", "Ø¨ÙŠÙƒØ§Ù†ØªÙˆ": "ÙƒÙŠØ§", "Ø±ÙŠÙˆ": "ÙƒÙŠØ§", "Ø³ÙŠØ±Ø§ØªÙˆ": "ÙƒÙŠØ§", "Ø³ÙˆØ±Ù†ØªÙˆ": "ÙƒÙŠØ§",
    "Ø³Ø¨ÙˆØ±ØªØ¬": "ÙƒÙŠØ§", "Ø§ÙˆØ¨ØªÙ…Ø§": "ÙƒÙŠØ§", "ÙÙŠØ³ØªÙˆ": "ÙƒÙŠØ§",
    
    "Ù„Ø§Ù†Ø³Ø±": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ", "Ø¨ÙˆÙ…Ø©": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ", "Ù‚Ø±Ø´": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ", "Ø¨Ø§Ø¬ÙŠØ±Ùˆ": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ",
    "Ø§ØªØ±Ø§Ø¬": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ", "Ø§ÙˆØªÙ„Ø§Ù†Ø¯Ø±": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ", "Ù…ÙŠØ±Ø§Ø¬": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ", "L300": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ",
    "ÙƒØ§Ù†ØªØ±": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ", "Ø¯ÙØ§Ø± Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ",
    
    "ØµÙ†ÙŠ": "Ù†ÙŠØ³Ø§Ù†", "Ø³Ù†ØªØ±Ø§": "Ù†ÙŠØ³Ø§Ù†", "ØªÙŠØ¯Ø§": "Ù†ÙŠØ³Ø§Ù†", "Ø¨Ø§ØªØ±ÙˆÙ„": "Ù†ÙŠØ³Ø§Ù†", "Ù…ÙˆØ±Ø§Ù†Ùˆ": "Ù†ÙŠØ³Ø§Ù†",
    "Ø§ÙƒØ³ ØªØ±ÙŠÙ„": "Ù†ÙŠØ³Ø§Ù†", "Ù„Ø§ÙÙŠÙ†Ø§": "Ù†ÙŠØ³Ø§Ù†",
    
    "Ø£Ù„ØªÙˆ": "Ø³ÙˆØ²ÙˆÙƒÙŠ", "Ø§Ù„ØªÙˆ": "Ø³ÙˆØ²ÙˆÙƒÙŠ", "ÙÙŠØªØ§Ø±Ø§": "Ø³ÙˆØ²ÙˆÙƒÙŠ", "Ø£Ù…Ø¬Ø§Ø¯": "Ø³ÙˆØ²ÙˆÙƒÙŠ", "Ø§Ù…Ø¬Ø§Ø¯": "Ø³ÙˆØ²ÙˆÙƒÙŠ",
    
    "Ø¨Ø§Ø³Ø§Øª": "ÙÙˆÙ„ÙƒØ³ ÙØ§Ø¬Ù†", "Ø¨ÙˆÙ„Ùˆ": "ÙÙˆÙ„ÙƒØ³ ÙØ§Ø¬Ù†", "Ø¨ÙˆØ±Ø§": "ÙÙˆÙ„ÙƒØ³ ÙØ§Ø¬Ù†",
    "Ø³ÙŠÙÙŠÙƒ": "Ù‡ÙˆÙ†Ø¯Ø§", "Ø³ÙŠØªÙŠ": "Ù‡ÙˆÙ†Ø¯Ø§",
    "ÙØ§Ø¨ÙŠØ§": "Ø³ÙƒÙˆØ¯Ø§", "Ø§ÙˆÙƒØªØ§ÙÙŠØ§": "Ø³ÙƒÙˆØ¯Ø§", "Ø³ÙŠØ¨Ø±ÙŠÙˆØ±": "Ø³ÙƒÙˆØ¯Ø§",
    "ØªÙƒØ³ÙŠ": "Ø¨ÙŠ ÙˆØ§ÙŠ Ø¯ÙŠ",
    
    "ÙÙˆÙ„ÙÙˆ": "Ø±Ø£Ø³ Ø´Ø§Ø­Ù†Ø©", "Ù…Ø§Ù†": "Ø±Ø£Ø³ Ø´Ø§Ø­Ù†Ø©", "Ù‡ÙŠÙ†Ùˆ": "Ø±Ø£Ø³ Ø´Ø§Ø­Ù†Ø©", "Ø§Ø³ÙƒØ§Ù†ÙŠØ§": "Ø±Ø£Ø³ Ø´Ø§Ø­Ù†Ø©",
    "Ø±ÙŠÙ†Ùˆ Ø´Ø§Ø­Ù†Ø©": "Ø±Ø£Ø³ Ø´Ø§Ø­Ù†Ø©", "Ø¯Ø§Ù": "Ø±Ø£Ø³ Ø´Ø§Ø­Ù†Ø©",
    
    "Ø¯ÙØ§Ø± Ø§ÙŠØ³ÙˆØ²Ùˆ": "Ø§ÙŠØ³ÙˆØ²Ùˆ", "Ø§ÙŠØ³ÙˆØ²Ùˆ": "Ø§ÙŠØ³ÙˆØ²Ùˆ",
    
    "Ù…Ø±Ø³ÙŠØ¯Ø³": "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰", "Ø¨ÙŠ Ø§Ù… Ø¯Ø¨Ù„ÙŠÙˆ": "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰", "Ø´ÙØ±ÙˆÙ„ÙŠÙ‡": "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰",
    "Ø¬ÙŠÙ„ÙŠ": "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰", "Ù…Ø§Ø²Ø¯Ø§": "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰", "Ø§Ù… Ø¬ÙŠ": "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰",
    "Ø¯Ø§ÙŠÙˆ": "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰", "Ù†ÙˆØ¨ÙŠØ±Ø§": "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰", "Ø¯Ø§Ù…Ø§Ø³": "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰"
};

const brands = ["ØªÙˆÙŠÙˆØªØ§", "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "ÙƒÙŠØ§", "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ", "Ù†ÙŠØ³Ø§Ù†", "Ø³ÙˆØ²ÙˆÙƒÙŠ", "ÙÙˆÙ„ÙƒØ³ ÙØ§Ø¬Ù†", 
                "Ù‡ÙˆÙ†Ø¯Ø§", "Ø³ÙƒÙˆØ¯Ø§", "Ø¨ÙŠ ÙˆØ§ÙŠ Ø¯ÙŠ", "ØªØ§ØªØ§", "Ø±Ø£Ø³ Ø´Ø§Ø­Ù†Ø©", "Ø§ÙŠØ³ÙˆØ²Ùˆ", "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰"];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Global State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cache = { found: new Map(), missing: new Map(), loaded: false };
let modalResolver = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Helper Functions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function normalizeChassis(num, isPlate) {
    if (isPlate || !num) return num;
    return num.length >= 4 ? num.slice(-4) : num.padStart(4, '0');
}

function findModel(text) {
    const lower = text.toLowerCase();
    for (let model in carModels) {
        if (lower.includes(model.toLowerCase())) {
            return { model, brand: carModels[model] };
        }
    }
    return null;
}

function extractModel(text) {
    const words = text.match(/[a-zA-ZØ¡-ÙŠ]+/g) || [];
    return words.find(w => w.length >= 3 && !['Ø´Ø§Ø³ÙŠ', 'Ù„ÙˆØ­Ø©', 'Ù„ÙˆØ­Ù‡', 'Ø±Ù‚Ù…'].includes(w)) || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
}

function showModal(modelName) {
    return new Promise(resolve => {
        modalResolver = resolve;
        document.getElementById('modelName').textContent = modelName;
        
        const select = document.getElementById('brandSelect');
        select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± --</option>';
        brands.forEach(b => select.innerHTML += `<option value="${b}">${b}</option>`);
        
        document.getElementById('modelModal').style.display = 'block';
    });
}

function saveModel() {
    const brand = document.getElementById('brandSelect').value;
    if (!brand) return alert('Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø±ÙƒØ©');
    
    const model = document.getElementById('modelName').textContent;
    carModels[model] = brand;
    
    document.getElementById('modelModal').style.display = 'none';
    if (modalResolver) modalResolver({ model, brand });
}

function skipModel() {
    document.getElementById('modelModal').style.display = 'none';
    if (modalResolver) modalResolver(null);
}

function setStatus(msg, color = '#333') {
    const el = document.getElementById('status');
    el.textContent = msg;
    el.style.color = color;
}

function setProgress(percent, show = true) {
    const bar = document.getElementById('progressBar');
    const container = document.getElementById('progress');
    bar.style.width = percent + '%';
    bar.textContent = percent + '%';
    container.style.display = show ? 'block' : 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Load Cache
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadCache() {
    if (cache.loaded) return;
    
    const [found, missing] = await Promise.all([
        db.collection('found_cars').get(),
        db.collection('missing_cars').get()
    ]);
    
    found.forEach(doc => cache.found.set(doc.data().chassis_full, doc.data()));
    missing.forEach(doc => {
        const d = doc.data();
        const key = `${d.chassis_suffix}_${d.is_plate}`;
        if (!cache.missing.has(key)) cache.missing.set(key, []);
        cache.missing.get(key).push(d);
    });
    
    cache.loaded = true;
    updateStats();
}

function updateStats() {
    document.getElementById('statFound').textContent = cache.found.size;
    document.getElementById('statMissing').textContent = 
        Array.from(cache.missing.values()).reduce((sum, arr) => sum + arr.length, 0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Process Data (Main Upload Function)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function processData() {
    const start = Date.now();
    const text = document.getElementById('dataInput').value.trim();
    const lines = text.split('\n').filter(l => l.trim());
    
    if (!lines.length) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹');
    
    document.getElementById('uploadBtn').disabled = true;
    setStatus('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...');
    setProgress(0);
    
    await loadCache();
    
    let finder = lines.find(l => /(0[19]\d{8,})/.test(l));
    finder = finder ? finder.match(/(0[19]\d{8,})/)[0] : "ØºÙŠØ± Ù…Ø³Ø¬Ù„";
    
    const batch = db.batch();
    let added = 0, skipped = 0, duplicates = 0;
    let matchesHTML = '';
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        setProgress(Math.round((i + 1) / lines.length * 100));
        
        const nums = line.match(/\d+/g);
        if (!nums) continue;
        
        const fullNum = nums.reduce((a, b) => a.length > b.length ? a : b);
        if (fullNum.length < 1) { skipped++; continue; }
        
        const isPlate = /Ù„ÙˆØ­Ù‡|Ù„ÙˆØ­Ø©/.test(line);
        const suffix = normalizeChassis(fullNum, isPlate);
        
        let info = findModel(line);
        if (!info) {
            info = await showModal(extractModel(line));
            if (!info) { skipped++; continue; }
        }
        
        if (cache.found.has(fullNum)) {
            duplicates++;
            continue;
        }
        
        const ref = db.collection('found_cars').doc();
        const data = {
            brand: info.brand,
            model: info.model,
            chassis_full: fullNum,
            chassis_suffix: suffix,
            is_plate: isPlate,
            finder_phone: finder,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        batch.set(ref, data);
        cache.found.set(fullNum, data);
        added++;
        
        // Check matches
        const key = `${suffix}_${isPlate}`;
        if (cache.missing.has(key)) {
            cache.missing.get(key).forEach(m => {
                matchesHTML += `<tr class="match-row"><td>${info.brand} - ${info.model}</td><td>${suffix}</td><td class="phone-owner">${m.owner_phone}</td><td class="phone-finder">${finder}</td></tr>`;
            });
        }
    }
    
    if (added > 0) await batch.commit();
    
    const time = ((Date.now() - start) / 1000).toFixed(1);
    document.getElementById('statSpeed').textContent = time + 's';
    setStatus(`âœ… Ø§Ù„Ù…Ø¶Ø§Ù: ${added} | Ø§Ù„Ù…ÙƒØ±Ø±: ${duplicates} | Ø§Ù„Ù…ØªØ¬Ø§Ù‡Ù„: ${skipped}`, '#28a745');
    setProgress(100, false);
    
    document.getElementById('matchesTable').innerHTML = matchesHTML || '<tr><td colspan="4" class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø·Ø§Ø¨Ù‚Ø§Øª</td></tr>';
    document.getElementById('uploadBtn').disabled = false;
    
    updateStats();
    loadPublicMatches();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Load Public Matches
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadPublicMatches() {
    const snap = await db.collection('confirmed_matches').orderBy('timestamp', 'desc').limit(50).get();
    let html = '';
    
    snap.forEach(d => {
        const data = d.data();
        const date = data.timestamp ? data.timestamp.toDate().toLocaleDateString('ar-EG') : '-';
        html += `<tr><td>${data.brand} - ${data.model}</td><td>${data.chassis_suffix}</td><td class="phone-owner">${data.owner_phone}</td><td class="phone-finder">${data.finder_phone}</td><td>${date}</td></tr>`;
    });
    
    document.getElementById('publicTable').innerHTML = html || '<tr><td colspan="5" class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø·Ø§Ø¨Ù‚Ø§Øª</td></tr>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Delete All Data
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function deleteAllData() {
    const code = prompt("âš ï¸ Ø±Ù…Ø² Ø§Ù„Ø­Ø°Ù:\n\nDELETE2026");
    if (code !== "DELETE2026") return alert("Ø±Ù…Ø² Ø®Ø§Ø·Ø¦");
    if (!confirm("ğŸš¨ Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ")) return;
    
    try {
        setStatus('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...');
        const cols = ['found_cars', 'missing_cars', 'confirmed_matches'];
        let total = 0;
        
        for (const col of cols) {
            const snap = await db.collection(col).get();
            for (const doc of snap.docs) {
                await doc.ref.delete();
                total++;
            }
        }
        
        cache.found.clear();
        cache.missing.clear();
        cache.loaded = false;
        
        alert(`âœ… ØªÙ… Ø­Ø°Ù ${total} Ø³Ø¬Ù„`);
        location.reload();
    } catch (e) {
        alert(`âŒ Ø®Ø·Ø£: ${e.message}\n\nØºÙŠÙ‘Ø± Firestore Rules:\nmatch /{document=**} { allow read, write: if true; }`);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Initialize
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.onload = async () => {
    await loadCache();
    await loadPublicMatches();
};
</script>
</body>
</html>
