<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… v9.0 - Ù†Ø¸ÙŠÙØ© ÙˆÙ…Ø­Ø³Ù‘Ù†Ø©</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
        
        /* ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        .login-page { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .login-card { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); max-width: 400px; width: 100%; }
        .login-card h2 { color: #1a73e8; margin-bottom: 30px; text-align: center; font-size: 28px; }
        .login-card input { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; }
        .login-card input:focus { outline: none; border-color: #1a73e8; }
        .login-card button { width: 100%; padding: 15px; margin-top: 20px; background: #1a73e8; color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .login-card button:hover { background: #0d47a1; transform: translateY(-2px); }
        .login-card button:disabled { background: #ccc; transform: none; cursor: not-allowed; }
        .error-msg { color: #dc3545; text-align: center; margin: 10px 0; font-weight: bold; font-size: 14px; }
        .logout-btn { position: fixed; top: 20px; left: 20px; padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; z-index: 100; }
        
        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        .container { max-width: 1200px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); display: none; }
        .user-info { background: #e3f2fd; padding: 12px; border-radius: 8px; margin-bottom: 20px; text-align: center; color: #0d47a1; font-weight: bold; }
        h2 { color: #1a73e8; border-bottom: 3px solid #1a73e8; padding-bottom: 15px; margin-bottom: 25px; font-size: 24px; }
        
        /* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-box { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .stat-box:nth-child(2) { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-box:nth-child(3) { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-num { font-size: 42px; font-weight: bold; display: block; margin-bottom: 5px; }
        .stat-label { font-size: 14px; opacity: 0.9; }
        
        /* Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ */
        textarea { width: 100%; height: 140px; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 15px; resize: vertical; font-family: inherit; }
        textarea:focus { outline: none; border-color: #1a73e8; }
        
        .btn { border: none; padding: 15px 30px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s; width: 100%; margin-top: 15px; }
        .btn-primary { background: #1a73e8; color: white; }
        .btn-primary:hover { background: #0d47a1; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(26,115,232,0.3); }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… */
        .progress { width: 100%; height: 30px; background: #e0e0e0; border-radius: 15px; overflow: hidden; margin: 15px 0; display: none; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #1a73e8, #28a745); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; }
        
        #status { text-align: center; margin: 15px 0; font-weight: bold; font-size: 16px; min-height: 24px; }
        
        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        .tables { display: grid; gap: 25px; margin-top: 30px; }
        .table-section { background: #f8f9fa; border-radius: 10px; overflow: hidden; border: 2px solid #e9ecef; }
        .table-header { padding: 15px; font-weight: bold; font-size: 16px; color: white; }
        .header-matches { background: #28a745; }
        .header-public { background: #17a2b8; }
        
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #f8f9fa; padding: 12px; text-align: right; font-weight: 600; border-bottom: 2px solid #dee2e6; }
        td { padding: 12px; border-bottom: 1px solid #e9ecef; }
        tr:hover { background: #f8f9fa; }
        .match-row { background: #fff3cd; border-right: 4px solid #ffc107; }
        .phone-owner { color: #dc3545; font-weight: 600; }
        .phone-finder { color: #007bff; font-weight: 600; }
        .empty-state { text-align: center; padding: 40px; color: #6c757d; font-size: 14px; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
        .modal-content { background: white; margin: 10% auto; padding: 30px; border-radius: 15px; max-width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: slideDown 0.3s; }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal h3 { color: #1a73e8; margin-bottom: 20px; font-size: 20px; }
        .modal select { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 15px; }
        .modal input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 15px; }
        .modal button { width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 8px; font-size: 15px; font-weight: bold; cursor: pointer; }
        .modal .btn-save { background: #28a745; color: white; }
        .modal .btn-skip { background: #6c757d; color: white; }
        .modal .btn-use { background: #17a2b8; color: white; }
        
        .correction-hint { background: #e7f3ff; border-left: 4px solid #2196F3; padding: 12px; margin: 10px 0; border-radius: 5px; font-size: 13px; color: #555; }
        .suggestions { display: flex; gap: 8px; flex-wrap: wrap; margin: 10px 0; }
        .suggestion-btn { background: #f0f0f0; border: 1px solid #ddd; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 13px; transition: 0.2s; }
        .suggestion-btn:hover { background: #e3f2fd; border-color: #2196F3; }
    </style>
</head>
<body>

<!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div class="login-page" id="loginPage">
    <div class="login-card">
        <h2>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h2>
        <div id="loginError" class="error-msg"></div>
        <input type="email" id="emailInput" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        <input type="password" id="passwordInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button id="loginBtn" onclick="handleLogin()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>
</div>

<!-- Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ -->
<button class="logout-btn" id="logoutBtn" onclick="handleLogout()" style="display: none;">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>

<!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
<div class="container" id="adminPanel">
    <div class="user-info" id="userInfo"></div>
    
    <h2>ğŸš€ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù†Ø³Ø®Ø© Ù†Ø¸ÙŠÙØ© ÙˆÙ…Ø­Ø³Ù‘Ù†Ø© v9.0</h2>
    
    <div id="adminPhone" style="background: #e3f2fd; padding: 12px; border-radius: 8px; margin-bottom: 20px; text-align: center; display: none;">
        <strong>ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</strong> <span id="phoneNumber" style="color: #1a73e8; font-size: 18px; font-weight: bold;"></span>
    </div>

    <div class="stats">
        <div class="stat-box">
            <span class="stat-num" id="statFound">0</span>
            <span class="stat-label">Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</span>
        </div>
        <div class="stat-box">
            <span class="stat-num" id="statMissing">0</span>
            <span class="stat-label">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¨Ø­Ø«</span>
        </div>
        <div class="stat-box">
            <span class="stat-num" id="statSpeed">--</span>
            <span class="stat-label">Ø³Ø±Ø¹Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</span>
        </div>
    </div>
    
    <div style="background: #e7f3ff; border-left: 4px solid #2196F3; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <strong>ğŸ’¡ Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø¶Ø¹ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙÙŠ <strong>Ø£ÙˆÙ„ Ø³Ø·Ø± Ø£Ùˆ Ø³Ø·Ø±ÙŠÙ†</strong> Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        <div style="margin-top: 8px; font-size: 13px; color: #555;">Ù…Ø«Ø§Ù„: 0912345678</div>
    </div>
    
    <textarea id="dataInput" placeholder="Ø§Ù„ØµÙ‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ù‡Ù†Ø§...&#10;&#10;Ù…Ø«Ø§Ù„:&#10;0912345678&#10;ÙƒÙˆØ±ÙˆÙ„Ø§ Ø´Ø§Ø³ÙŠ 1234&#10;ÙƒØ§Ù…Ø±ÙŠ Ø´Ø§Ø³ÙŠ 5678"></textarea>
    
    <button class="btn btn-primary" id="uploadBtn" onclick="processData()">âš¡ Ø±ÙØ¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
    
    <div class="progress" id="progress">
        <div class="progress-bar" id="progressBar">0%</div>
    </div>
    
    <div id="status"></div>
    
    <button class="btn btn-danger" onclick="deleteAllData()">ğŸ—‘ï¸ Ù…Ø³Ø­ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>

    <div class="tables">
        <div class="table-section">
            <div class="table-header header-matches">âœ¨ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ©</div>
            <table>
                <thead><tr><th>Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø§Ù„Ùƒ</th><th>Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th></tr></thead>
                <tbody id="matchesTable"></tbody>
            </table>
        </div>

        <div class="table-section">
            <div class="table-header header-public">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</div>
            <table>
                <thead><tr><th>Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø§Ù„Ùƒ</th><th>Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead>
                <tbody id="publicTable"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Ù„Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
<div id="modelModal" class="modal">
    <div class="modal-content">
        <h3>ğŸš— Ù…ÙˆØ¯ÙŠÙ„ Ø¬Ø¯ÙŠØ¯: <span id="modelName"></span></h3>
        <p>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©:</p>
        <select id="brandSelect"></select>
        <button class="btn-save" onclick="saveModel()">Ø­ÙØ¸</button>
        <button class="btn-skip" onclick="skipModel()">ØªØ¬Ø§Ù‡Ù„</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script >// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SMART MATCHING SYSTEM v1.0
// Based on real Sudan car lists analysis
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ø§Ø®ØªØµØ§Ø±Ø§Øª ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø´Ø¹Ø¨ÙŠØ© (Ù…Ù† Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙØ¹Ù„ÙŠ)
const carAliases = {
    // ØªÙˆÙŠÙˆØªØ§
    "Ù…ÙˆÙ†ÙƒØ§": { model: "ÙƒÙˆØ±ÙˆÙ„Ø§", brand: "ØªÙˆÙŠÙˆØªØ§" },
    "Ù…ÙˆÙ†ÙŠÙƒØ§": { model: "ÙƒÙˆØ±ÙˆÙ„Ø§", brand: "ØªÙˆÙŠÙˆØªØ§" },
    "Ø´Ø±ÙŠØ­Ù‡": { model: "Ù‡Ø§ÙŠØ³", brand: "ØªÙˆÙŠÙˆØªØ§" },
    "Ø´Ø±ÙŠØ­Ø©": { model: "Ù‡Ø§ÙŠØ³", brand: "ØªÙˆÙŠÙˆØªØ§" },
    "Ø¨ÙˆÙƒØ³ÙŠ": { model: "Ù‡Ø§ÙŠÙ„ÙˆÙƒØ³", brand: "ØªÙˆÙŠÙˆØªØ§" },
    "Ø¨ÙˆÙƒØ³": { model: "Ù‡Ø§ÙŠÙ„ÙˆÙƒØ³", brand: "ØªÙˆÙŠÙˆØªØ§" },
    "Ø¨ÙƒØ³ ØªØ§ÙŠÙˆØªØ§": { model: "Ù‡Ø§ÙŠÙ„ÙˆÙƒØ³", brand: "ØªÙˆÙŠÙˆØªØ§" },
    
    // Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ
    "Ù…Ø¶Ù„Ø¹": { model: "Ø§ÙƒØ³Ù†Øª", brand: "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ" },
    "Ø¯Ø¨Ø¯ÙˆØ¨": { model: "Ø§ÙƒØ³Ù†Øª", brand: "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ" },
    "Ø¬ÙŠØ§Ø¯": { model: "Ø§ÙƒØ³Ù†Øª", brand: "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ" },
    "Ø³Ø­Ù„ÙŠØ©": { model: "Ø£ÙØ§Ù†ØªÙŠ", brand: "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ" },
    "Ø³Ø­Ù„ÙŠÙ‡": { model: "Ø£ÙØ§Ù†ØªÙŠ", brand: "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ" },
    "Ù…Ù†ÙÙˆØ®Ù‡": { model: "Ø£ÙØ§Ù†ØªÙŠ", brand: "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ" },
    "Ù…Ù†ÙÙˆØ®Ø©": { model: "Ø£ÙØ§Ù†ØªÙŠ", brand: "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ" },
    "ÙƒØ±ÙŠØ³": { model: "Ø¬Ø±ÙŠØ³", brand: "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ" },
    "ÙƒØ±ÙŠØ²": { model: "Ø¬Ø±ÙŠØ³", brand: "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ" },
    "Ø³Ø§Ø±ÙŠÙƒØ³": { model: "Ø§Ø³ØªØ§ÙŠØ±ÙƒØ³", brand: "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ" },
    "Ø³ØªØ§ÙŠØ±ÙƒØ³": { model: "Ø§Ø³ØªØ§ÙŠØ±ÙƒØ³", brand: "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ" },
    
    // Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ
    "Ø¨ÙˆÙ…Ù‡": { model: "Ù„Ø§Ù†Ø³Ø±", brand: "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ" },
    "Ø¨ÙˆÙ…Ø©": { model: "Ù„Ø§Ù†Ø³Ø±", brand: "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ" },
    "Ù‚Ø±Ø´": { model: "Ù„Ø§Ù†Ø³Ø±", brand: "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ" },
    
    // Ø£Ø®Ø±Ù‰
    "Ø´ÙØ±": { model: "Ø´ÙØ±ÙˆÙ„ÙŠÙ‡", brand: "Ø´ÙØ±ÙˆÙ„ÙŠÙ‡" },
    "Ø§Ù„ØªÙˆ": { model: "Ø£Ù„ØªÙˆ", brand: "Ø³ÙˆØ²ÙˆÙƒÙŠ" }
};

// Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„ØªØµØ­ÙŠØ­Ø§Øª Ø§Ù„Ø¥Ù…Ù„Ø§Ø¦ÙŠØ© (Ù…Ù† Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ÙØ¹Ù„ÙŠØ©)
const spellingFixes = {
    "ÙƒÙˆØ±ÙŠÙ„Ø§": "ÙƒÙˆØ±ÙˆÙ„Ø§",
    "ÙƒØ±ÙˆÙ„Ø§": "ÙƒÙˆØ±ÙˆÙ„Ø§",
    "ÙƒÙˆØ±Ù„Ø§": "ÙƒÙˆØ±ÙˆÙ„Ø§",
    "Ù…ÙˆØ±Ù†ÙŠÙ†Øº": "Ù…ÙˆØ±Ù†ÙŠÙ‚",
    "Ù…ÙˆØ±Ù†Ù†Øº": "Ù…ÙˆØ±Ù†ÙŠÙ‚",
    "Ù…ÙˆØ±Ù†Ù†Ù‚": "Ù…ÙˆØ±Ù†ÙŠÙ‚",
    "Ù…ÙˆØ±Ù†ÙŠÙ†Ù‚": "Ù…ÙˆØ±Ù†ÙŠÙ‚",
    "Ø§ÙƒØ³Ù†": "Ø§ÙƒØ³Ù†Øª",
    "ÙƒÙ„Ùƒ": "ÙƒÙ„ÙŠÙƒ",
    "ÙƒÙŠÙ„Ùƒ": "ÙƒÙ„ÙŠÙƒ",
    "ÙƒÙ„ÙŠÙ„Ùƒ": "ÙƒÙ„ÙŠÙƒ",
    "Ø´ÙŠÙØ±ÙˆÙ„ÙŠÙ‡": "Ø´ÙØ±ÙˆÙ„ÙŠÙ‡",
    "ÙØ§Ù†ØªÙŠ": "Ø§ÙØ§Ù†ØªÙŠ",
    "Ù„Ø§Ù†Ø³": "Ù„Ø§Ù†Ø³Ø±",
    "Ø§Ø³Ø¨ÙˆØ±ØªØ§Ø¬": "Ø³Ø¨ÙˆØ±ØªØ§Ø¬",
    "Ø³Ø¨ÙˆØ±ØªØ§Ø¬": "Ø³Ø¨ÙˆØ±ØªØ§Ø¬",
    "Ø§Ø³ØªØ§Ø±ÙŠÙƒØ³": "Ø§Ø³ØªØ§ÙŠØ±ÙƒØ³",
    "Ø§ÙˆØ¨ØªÙ…Ø§": "Ø§ÙˆØ¨ØªÙŠÙ…Ø§",
    "ÙØ³ÙŠØªÙˆ": "ÙÙŠØ³ØªÙˆ",
    "ÙŠØ§Ø±Ø³": "ÙŠØ§Ø±ÙŠØ³",
    "Ø¯Ø³ØªØ±": "Ø¯Ø§Ø³ØªØ±",
    "Ù…Ø§Ø±ÙŠØ³Ø¯Ø³": "Ù…Ø±Ø³ÙŠØ¯Ø³",
    "Ù…Ø§Ø±Ø³ÙŠØ¯Ø³": "Ù…Ø±Ø³ÙŠØ¯Ø³",
    "ØªØ§ÙŠÙˆØªÙ‡": "ØªÙˆÙŠÙˆØªØ§",
    "ØªÙˆÙŠÙŠØ±Ø§": "ØªÙˆÙŠÙˆØªØ§",
    "Ù…ØªØ³ÙˆØ¨ÙŠØ´ÙŠ": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ",
    "Ù…Ø³ØªØ¨ÙŠØ´ÙŠ": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ",
    "Ù…Ø³ØªÙˆØ¨ÙŠØ´ÙŠ": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ",
    "Ù…ÙŠØ³ØªÙˆØ¨ÙŠØ´ÙŠ": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ",
    "Ø¯ÙŠÙ‡Ø§ØªØ³Ùˆ": "Ø¯Ø§ÙŠÙ‡Ø§ØªØ³Ùˆ",
    "Ø¯Ù‡Ø§ØªØ³ÙˆÙ†": "Ø¯Ø§ÙŠÙ‡Ø§ØªØ³Ùˆ",
    "ÙÙ„ÙˆÙƒØ³ÙˆØ§Ø¬Ù†": "ÙÙˆÙ„ÙƒØ³ ÙØ§Ø¬Ù†",
    "Ø¨ÙŠØ±Ø§Ø¯Ùˆ": "Ø¨Ø±Ø§Ø¯Ùˆ",
    "Ø¯ÙŠØ¯ÙˆÙ†": "Ø¯Ø¨Ø¯ÙˆØ¨",
    "Ø¬Ù†Ø³ÙŠ": "ØµÙ†ÙŠ"
};

// ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ
function normalizeArabic(text) {
    if (!text) return '';
    return text
        .replace(/[Ø£Ø¥Ø¢]/g, 'Ø§')
        .replace(/[Ù‰Ø¦]/g, 'ÙŠ')
        .replace(/Ø©/g, 'Ù‡')
        .replace(/\s+/g, '')
        .trim();
}

// ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
function convertArabicNumbers(str) {
    if (!str) return str;
    const arabicNums = ['Ù ','Ù¡','Ù¢','Ù£','Ù¤','Ù¥','Ù¦','Ù§','Ù¨','Ù©'];
    const englishNums = ['0','1','2','3','4','5','6','7','8','9'];
    let result = str;
    for (let i = 0; i < 10; i++) {
        result = result.replace(new RegExp(arabicNums[i], 'g'), englishNums[i]);
    }
    return result;
}

// Ø­Ø³Ø§Ø¨ Levenshtein Distance
function levenshteinDistance(s1, s2) {
    if (!s1 || !s2) return 999;
    const m = s1.length, n = s2.length;
    const dp = Array(m + 1).fill().map(() => Array(n + 1).fill(0));
    
    for (let i = 0; i <= m; i++) dp[i][0] = i;
    for (let j = 0; j <= n; j++) dp[0][j] = j;
    
    for (let i = 1; i <= m; i++) {
        for (let j = 1; j <= n; j++) {
            if (s1[i-1] === s2[j-1]) {
                dp[i][j] = dp[i-1][j-1];
            } else {
                dp[i][j] = Math.min(
                    dp[i-1][j] + 1,
                    dp[i][j-1] + 1,
                    dp[i-1][j-1] + 1
                );
            }
        }
    }
    return dp[m][n];
}

// Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ø¹Ù† Ù…ÙˆØ¯ÙŠÙ„
function smartModelMatch(input, carModels) {
    if (!input) return null;
    
    const original = input;
    input = input.trim();
    
    // 1. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ø¥Ù…Ù„Ø§Ø¦ÙŠ
    if (spellingFixes[input]) {
        input = spellingFixes[input];
    }
    
    // 2. Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø§Ø®ØªØµØ§Ø±Ø§Øª
    if (carAliases[input]) {
        return {
            model: carAliases[input].model,
            brand: carAliases[input].brand,
            confidence: 100,
            method: "alias",
            original: original
        };
    }
    
    const normalized = normalizeArabic(input);
    
    // 3. ØªØ·Ø§Ø¨Ù‚ ØªØ§Ù… Ø¨Ø¹Ø¯ Ø§Ù„ØªØ·Ø¨ÙŠØ¹
    for (let model in carModels) {
        if (normalizeArabic(model) === normalized) {
            return {
                model: model,
                brand: carModels[model],
                confidence: 100,
                method: "exact",
                original: original
            };
        }
    }
    
    // 4. Fuzzy matching
    let bestMatch = null;
    let bestDistance = Infinity;
    
    for (let model in carModels) {
        const distance = levenshteinDistance(normalized, normalizeArabic(model));
        const threshold = Math.min(2, Math.ceil(normalized.length / 3));
        
        if (distance <= threshold && distance < bestDistance) {
            bestDistance = distance;
            bestMatch = model;
        }
    }
    
    if (bestMatch && bestDistance <= 2) {
        const confidence = Math.max(75, Math.round(100 - (bestDistance / normalized.length * 100)));
        return {
            model: bestMatch,
            brand: carModels[bestMatch],
            confidence: confidence,
            method: "fuzzy",
            distance: bestDistance,
            original: original
        };
    }
    
    return null;
}

// Ø¯Ù…Ø¬ Ù…Ø¹ findModel Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
function enhancedFindModel(line, carModels) {
    if (!line) return null;
    
    // 1. Ø¨Ø­Ø« Ø¹Ø§Ø¯ÙŠ Ø£ÙˆÙ„Ø§Ù‹ (Ø³Ø±ÙŠØ¹)
    for (let model in carModels) {
        if (line.includes(model)) {
            return {
                model: model,
                brand: carModels[model],
                confidence: 100,
                method: "direct"
            };
        }
    }
    
    // 2. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„
    let extracted = line
        .replace(/Ø´Ø§Ø³ÙŠ|Ù„ÙˆØ­Ø©|Ù„ÙˆØ­Ù‡|Ø±Ù‚Ù…/gi, '')
        .replace(/\d+/g, '')
        .trim();
    
    const words = extracted.split(/\s+/);
    
    // 3. Ù…Ø­Ø§ÙˆÙ„Ø© ÙƒÙ„ ÙƒÙ„Ù…Ø©
    for (let word of words) {
        if (word.length < 2) continue;
        
        const match = smartModelMatch(word, carModels);
        if (match && match.confidence >= 75) {
            return match;
        }
    }
    
    // 4. Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¬Ù…Ù„Ø© ÙƒØ§Ù…Ù„Ø©
    const fullMatch = smartModelMatch(extracted, carModels);
    if (fullMatch && fullMatch.confidence >= 75) {
        return fullMatch;
    }
    
    return null;
}

// ØªØµØ¯ÙŠØ± Ø§Ù„Ø¯ÙˆØ§Ù„
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        normalizeArabic,
        convertArabicNumbers,
        levenshteinDistance,
        smartModelMatch,
        enhancedFindModel,
        carAliases,
        spellingFixes
    };
}
</script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Firebase Configuration
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig = {
    apiKey: "AIzaSyDvAx6-priGfzGLh2AlazSkIvsoc0OcW4Q",
    authDomain: "sudancarsrecover.firebaseapp.com",
    projectId: "sudancarsrecover",
    storageBucket: "sudancarsrecover.firebasestorage.app",
    messagingSenderId: "222129422162",
    appId: "1:222129422162:web:c3e8d3c498b53f96afc48b"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Authentication Functions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
auth.onAuthStateChanged(user => {
    if (user) {
        showAdminPanel(user);
    } else {
        showLoginPage();
    }
});

function showLoginPage() {
    document.getElementById('loginPage').style.display = 'flex';
    document.getElementById('adminPanel').style.display = 'none';
    document.getElementById('logoutBtn').style.display = 'none';
}

function showAdminPanel(user) {
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('adminPanel').style.display = 'block';
    document.getElementById('logoutBtn').style.display = 'block';
    document.getElementById('userInfo').innerHTML = `ğŸ‘¤ <strong>${user.email}</strong>`;
    
    loadCache();
    loadPublicMatches();
}

async function handleLogin() {
    const email = document.getElementById('emailInput').value.trim();
    const password = document.getElementById('passwordInput').value;
    const loginBtn = document.getElementById('loginBtn');
    const errorDiv = document.getElementById('loginError');
    
    if (!email || !password) {
        errorDiv.textContent = 'âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±';
        return;
    }
    
    loginBtn.disabled = true;
    loginBtn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...';
    errorDiv.textContent = '';
    
    try {
        await auth.signInWithEmailAndPassword(email, password);
    } catch (error) {
        let errorMsg = 'âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
        
        if (error.code === 'auth/user-not-found') errorMsg = 'âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
        else if (error.code === 'auth/wrong-password') errorMsg = 'âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©';
        else if (error.code === 'auth/invalid-email') errorMsg = 'âŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­';
        else if (error.code === 'auth/too-many-requests') errorMsg = 'âŒ Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø©. Ø­Ø§ÙˆÙ„ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„';
        
        errorDiv.textContent = errorMsg;
    } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
    }
}

async function handleLogout() {
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
        await auth.signOut();
    }
}

// Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
document.addEventListener('DOMContentLoaded', () => {
    const passwordInput = document.getElementById('passwordInput');
    if (passwordInput) {
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Car Models Database
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const carModels = {
    "ÙƒÙˆØ±ÙˆÙ„Ø§": "ØªÙˆÙŠÙˆØªØ§", "Ù…ÙˆÙ†ÙƒØ§": "ØªÙˆÙŠÙˆØªØ§", "ÙƒØ§Ù…Ø±ÙŠ": "ØªÙˆÙŠÙˆØªØ§", "Ù„Ø§Ù†Ø¯ÙƒØ±ÙˆØ²Ø±": "ØªÙˆÙŠÙˆØªØ§", "ÙƒØ±ÙˆØ²Ø±": "ØªÙˆÙŠÙˆØªØ§",
    "Ø¨Ø±Ø§Ø¯Ùˆ": "ØªÙˆÙŠÙˆØªØ§", "ÙÙˆØ±Ø´Ù†Ø±": "ØªÙˆÙŠÙˆØªØ§", "Ù‡Ø§ÙŠÙ„ÙˆÙƒØ³": "ØªÙˆÙŠÙˆØªØ§", "Ø¨ÙˆÙƒØ³ÙŠ": "ØªÙˆÙŠÙˆØªØ§", "ÙŠØ§Ø±Ø³": "ØªÙˆÙŠÙˆØªØ§",
    "Ù‡Ø§ÙŠØ³": "ØªÙˆÙŠÙˆØªØ§", "Ø´Ø±ÙŠØ­Ø©": "ØªÙˆÙŠÙˆØªØ§", "Ø±Ø§Ù": "ØªÙˆÙŠÙˆØªØ§", "ÙƒÙˆØ³ØªØ±": "ØªÙˆÙŠÙˆØªØ§",
    
    "Ø§ÙƒØ³Ù†Øª": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ù…Ø¶Ù„Ø¹": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø¯Ø¨Ø¯ÙˆØ¨": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø¬ÙŠØ§Ø¯": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø£ÙØ§Ù†ØªÙŠ": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ",
    "Ø§ÙØ§Ù†ØªÙŠ": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø³Ø­Ù„ÙŠØ©": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ù…Ù†ÙÙˆØ®Ø©": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "ÙÙŠØ±Ù†Ø§": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø§ÙŠ ØªÙ†": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ",
    "Ø·ÙŠÙˆØ± Ø§Ù„Ø¬Ù†Ø©": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "ÙƒÙ„Ùƒ": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ù‚ÙŠØªØ²": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "ØªÙˆØ³Ø§Ù†": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø³Ù†ØªØ§ÙÙŠ": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ",
    "Ø³ÙˆÙ†Ø§ØªØ§": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø¥Ù„Ù†ØªØ±Ø§": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø§Ù„Ù†ØªØ±Ø§": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø³ØªØ§Ø±ÙŠÙƒØ³": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø§ØªØ´ ÙˆÙ†": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ",
    "Ø¬Ø±ÙŠØ³": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "ÙƒØ±ÙŠØ²": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø§ÙŠÙˆÙ†": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ù…Ø§ØªØ±ÙƒØ³": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ù„Ø§ÙÙŠØªØ§": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ",
    "Ø¨ÙˆØ±ØªØ± Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø§ØªÙˆØ³": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø§ØªØ³": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ",
    
    "Ù…ÙˆØ±Ù†ÙŠÙ‚": "ÙƒÙŠØ§", "Ø¨ÙŠÙƒØ§Ù†ØªÙˆ": "ÙƒÙŠØ§", "Ø±ÙŠÙˆ": "ÙƒÙŠØ§", "Ø³ÙŠØ±Ø§ØªÙˆ": "ÙƒÙŠØ§", "Ø³ÙˆØ±Ù†ØªÙˆ": "ÙƒÙŠØ§",
    "Ø³Ø¨ÙˆØ±ØªØ¬": "ÙƒÙŠØ§", "Ø§ÙˆØ¨ØªÙ…Ø§": "ÙƒÙŠØ§", "ÙÙŠØ³ØªÙˆ": "ÙƒÙŠØ§",
    
    "Ù„Ø§Ù†Ø³Ø±": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ", "Ø¨ÙˆÙ…Ø©": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ", "Ù‚Ø±Ø´": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ", "Ø¨Ø§Ø¬ÙŠØ±Ùˆ": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ",
    "Ø§ØªØ±Ø§Ø¬": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ", "Ø§ÙˆØªÙ„Ø§Ù†Ø¯Ø±": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ", "Ù…ÙŠØ±Ø§Ø¬": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ", "L300": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ",
    "ÙƒØ§Ù†ØªØ±": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ", "Ø¯ÙØ§Ø± Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ",
    
    "ØµÙ†ÙŠ": "Ù†ÙŠØ³Ø§Ù†", "Ø³Ù†ØªØ±Ø§": "Ù†ÙŠØ³Ø§Ù†", "ØªÙŠØ¯Ø§": "Ù†ÙŠØ³Ø§Ù†", "Ø¨Ø§ØªØ±ÙˆÙ„": "Ù†ÙŠØ³Ø§Ù†", "Ù…ÙˆØ±Ø§Ù†Ùˆ": "Ù†ÙŠØ³Ø§Ù†",
    "Ø§ÙƒØ³ ØªØ±ÙŠÙ„": "Ù†ÙŠØ³Ø§Ù†", "Ù„Ø§ÙÙŠÙ†Ø§": "Ù†ÙŠØ³Ø§Ù†",
    
    "Ø£Ù„ØªÙˆ": "Ø³ÙˆØ²ÙˆÙƒÙŠ", "Ø§Ù„ØªÙˆ": "Ø³ÙˆØ²ÙˆÙƒÙŠ", "ÙÙŠØªØ§Ø±Ø§": "Ø³ÙˆØ²ÙˆÙƒÙŠ", "Ø£Ù…Ø¬Ø§Ø¯": "Ø³ÙˆØ²ÙˆÙƒÙŠ", "Ø§Ù…Ø¬Ø§Ø¯": "Ø³ÙˆØ²ÙˆÙƒÙŠ",
    
    "Ø¨Ø§Ø³Ø§Øª": "ÙÙˆÙ„ÙƒØ³ ÙØ§Ø¬Ù†", "Ø¨ÙˆÙ„Ùˆ": "ÙÙˆÙ„ÙƒØ³ ÙØ§Ø¬Ù†", "Ø¨ÙˆØ±Ø§": "ÙÙˆÙ„ÙƒØ³ ÙØ§Ø¬Ù†",
    "Ø³ÙŠÙÙŠÙƒ": "Ù‡ÙˆÙ†Ø¯Ø§", "Ø³ÙŠØªÙŠ": "Ù‡ÙˆÙ†Ø¯Ø§",
    "ÙØ§Ø¨ÙŠØ§": "Ø³ÙƒÙˆØ¯Ø§", "Ø§ÙˆÙƒØªØ§ÙÙŠØ§": "Ø³ÙƒÙˆØ¯Ø§", "Ø³ÙŠØ¨Ø±ÙŠÙˆØ±": "Ø³ÙƒÙˆØ¯Ø§",
    "ØªÙƒØ³ÙŠ": "Ø¨ÙŠ ÙˆØ§ÙŠ Ø¯ÙŠ",
    
    "ÙÙˆÙ„ÙÙˆ": "Ø±Ø£Ø³ Ø´Ø§Ø­Ù†Ø©", "Ù…Ø§Ù†": "Ø±Ø£Ø³ Ø´Ø§Ø­Ù†Ø©", "Ù‡ÙŠÙ†Ùˆ": "Ø±Ø£Ø³ Ø´Ø§Ø­Ù†Ø©", "Ø§Ø³ÙƒØ§Ù†ÙŠØ§": "Ø±Ø£Ø³ Ø´Ø§Ø­Ù†Ø©",
    "Ø±ÙŠÙ†Ùˆ Ø´Ø§Ø­Ù†Ø©": "Ø±Ø£Ø³ Ø´Ø§Ø­Ù†Ø©", "Ø¯Ø§Ù": "Ø±Ø£Ø³ Ø´Ø§Ø­Ù†Ø©",
    
    "Ø¯ÙØ§Ø± Ø§ÙŠØ³ÙˆØ²Ùˆ": "Ø§ÙŠØ³ÙˆØ²Ùˆ", "Ø§ÙŠØ³ÙˆØ²Ùˆ": "Ø§ÙŠØ³ÙˆØ²Ùˆ",
    
    "Ù…Ø±Ø³ÙŠØ¯Ø³": "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰", "Ø¨ÙŠ Ø§Ù… Ø¯Ø¨Ù„ÙŠÙˆ": "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰", "Ø´ÙØ±ÙˆÙ„ÙŠÙ‡": "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰",
    "Ø¬ÙŠÙ„ÙŠ": "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰", "Ù…Ø§Ø²Ø¯Ø§": "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰", "Ø§Ù… Ø¬ÙŠ": "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰",
    "Ø¯Ø§ÙŠÙˆ": "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰", "Ù†ÙˆØ¨ÙŠØ±Ø§": "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰", "Ø¯Ø§Ù…Ø§Ø³": "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰"
};

const brands = ["ØªÙˆÙŠÙˆØªØ§", "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "ÙƒÙŠØ§", "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ", "Ù†ÙŠØ³Ø§Ù†", "Ø³ÙˆØ²ÙˆÙƒÙŠ", "ÙÙˆÙ„ÙƒØ³ ÙØ§Ø¬Ù†", 
                "Ù‡ÙˆÙ†Ø¯Ø§", "Ø³ÙƒÙˆØ¯Ø§", "Ø¨ÙŠ ÙˆØ§ÙŠ Ø¯ÙŠ", "ØªØ§ØªØ§", "Ø±Ø£Ø³ Ø´Ø§Ø­Ù†Ø©", "Ø§ÙŠØ³ÙˆØ²Ùˆ", "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰"];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Global State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cache = { found: new Map(), missing: new Map(), loaded: false };
let modalResolver = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Helper Functions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function normalizeChassis(num, isPlate) {
    if (isPlate || !num) return num;
    return num.length >= 4 ? num.slice(-4) : num.padStart(4, '0');
}

function findModel(line) {
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø©
    const result = enhancedFindModel(line, carModels);
    
    if (result && result.confidence >= 75) {
        // Ø¹Ø±Ø¶ ÙÙŠ Console Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
        if (result.method !== 'direct') {
            console.log(`ğŸ” ${result.original} â†’ ${result.model} (${result.confidence}% via ${result.method})`);
        }
        return { 
            model: result.model, 
            brand: result.brand 
        };
    }
    
    return null;
}

function extractModel(text) {
    const words = text.match(/[a-zA-ZØ¡-ÙŠ]+/g) || [];
    return words.find(w => w.length >= 3 && !['Ø´Ø§Ø³ÙŠ', 'Ù„ÙˆØ­Ø©', 'Ù„ÙˆØ­Ù‡', 'Ø±Ù‚Ù…'].includes(w)) || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
}

function showModal(modelName) {
    return new Promise(resolve => {
        modalResolver = resolve;
        document.getElementById('modelName').textContent = modelName;
        
        const select = document.getElementById('brandSelect');
        select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± --</option>';
        brands.forEach(b => select.innerHTML += `<option value="${b}">${b}</option>`);
        
        document.getElementById('modelModal').style.display = 'block';
    });
}

function saveModel() {
    const brand = document.getElementById('brandSelect').value;
    if (!brand) return alert('Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø±ÙƒØ©');
    
    const model = document.getElementById('modelName').textContent;
    carModels[model] = brand;
    
    document.getElementById('modelModal').style.display = 'none';
    if (modalResolver) modalResolver({ model, brand });
}

function skipModel() {
    document.getElementById('modelModal').style.display = 'none';
    if (modalResolver) modalResolver(null);
}

function setStatus(msg, color = '#333') {
    const el = document.getElementById('status');
    el.textContent = msg;
    el.style.color = color;
}

function setProgress(percent, show = true) {
    const bar = document.getElementById('progressBar');
    const container = document.getElementById('progress');
    bar.style.width = percent + '%';
    bar.textContent = percent + '%';
    container.style.display = show ? 'block' : 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Load Cache
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadCache() {
    if (cache.loaded) return;
    
    const [found, missing] = await Promise.all([
        db.collection('found_cars').get(),
        db.collection('missing_cars').get()
    ]);
    
    found.forEach(doc => cache.found.set(doc.data().chassis_full, doc.data()));
    missing.forEach(doc => {
        const d = doc.data();
        const key = `${d.chassis_suffix}_${d.is_plate}`;
        if (!cache.missing.has(key)) cache.missing.set(key, []);
        cache.missing.get(key).push(d);
    });
    
    cache.loaded = true;
    updateStats();
}

function updateStats() {
    document.getElementById('statFound').textContent = cache.found.size;
    document.getElementById('statMissing').textContent = 
        Array.from(cache.missing.values()).reduce((sum, arr) => sum + arr.length, 0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Process Data (Main Upload Function)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function processData() {
    if (!auth.currentUser) {
        alert('âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
        return;
    }
    
    const start = Date.now();
    const text = document.getElementById('dataInput').value.trim();
    const lines = text.split('\n').filter(l => l.trim());
    
    if (!lines.length) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹');
    
    document.getElementById('uploadBtn').disabled = true;
    setStatus('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...');
    setProgress(0);
    
    await loadCache();
    
    // Ø±Ù‚Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙŠÙƒÙˆÙ† ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø£ÙˆÙ„ Ø³Ø·Ø±ÙŠÙ†)
    let finder = "ØºÙŠØ± Ù…Ø³Ø¬Ù„";
    const firstTwoLines = lines.slice(0, 2).join(' ');
    const phoneMatch = firstTwoLines.match(/(0[19]\d{8,})/);
    if (phoneMatch) finder = phoneMatch[0];
    
    const batch = db.batch();
    let added = 0, skipped = 0, duplicates = 0;
    let matchesHTML = '';
    
    // Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
    function convertArabicNums(str) {
        const arabicNums = ['Ù ','Ù¡','Ù¢','Ù£','Ù¤','Ù¥','Ù¦','Ù§','Ù¨','Ù©'];
        const englishNums = ['0','1','2','3','4','5','6','7','8','9'];
        for (let i = 0; i < 10; i++) {
            str = str.replace(new RegExp(arabicNums[i], 'g'), englishNums[i]);
        }
        return str;
    }
    
    for (let i = 0; i < lines.length; i++) {
        let line = lines[i].trim();
        setProgress(Math.round((i + 1) / lines.length * 100));
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³Ø·Ø±
        line = line.replace(/^\*+\s*/, '');     // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø¬ÙˆÙ… Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
        line = line.replace(/\.{2,}/g, ' ');    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
        line = convertArabicNums(line);          // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
        
        // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø³Ø·Ø± ØºÙŠØ± Ø§Ù„Ù…ÙÙŠØ¯Ø©
        if (!line || line.length < 3) continue;
        if (/^(Ø­ØµØ±|Ø±Ù‚Ù…|Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„)/i.test(line)) continue;
        
        const nums = line.match(/\d+/g);
        if (!nums) { skipped++; continue; }
        
        const fullNum = nums.reduce((a, b) => a.length > b.length ? a : b);
        
        // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØºØ±ÙŠØ¨Ø©
        if (fullNum.length < 3 || fullNum.length > 15) { 
            skipped++; 
            continue; 
        }
        
        const isPlate = /Ù„ÙˆØ­Ù‡|Ù„ÙˆØ­Ø©|\/Ø®/.test(line);
        const suffix = normalizeChassis(fullNum, isPlate);
        
        let info = findModel(line);
        if (!info) {
            // Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ØŒ Ù†Ø¶ÙŠÙ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù€ "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰"
            // Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ = ÙƒÙ„ Ø§Ù„Ø³Ø·Ø± Ù…Ø§ Ø¹Ø¯Ø§ Ø±Ù‚Ù… Ø§Ù„Ø´Ø§Ø³ÙŠ
            let modelText = line.replace(fullNum, '').trim();
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙÙŠØ¯Ø©
            modelText = modelText.replace(/Ø´Ø§Ø³ÙŠ|Ù„ÙˆØ­Ø©|Ù„ÙˆØ­Ù‡|Ø±Ù‚Ù…/gi, '').trim();
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Øµ ÙØ§Ø¶ÙŠ Ø£Ùˆ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹ØŒ Ù†Ø³ØªØ®Ø¯Ù… "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"
            if (!modelText || modelText.length < 2) {
                modelText = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
            }
            
            info = {
                brand: "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰",
                model: modelText
            };
        }
        
        if (cache.found.has(fullNum)) {
            duplicates++;
            continue;
        }
        
        const ref = db.collection('found_cars').doc();
        const data = {
            brand: info.brand,
            model: info.model,
            chassis_full: fullNum,
            chassis_suffix: suffix,
            is_plate: isPlate,
            finder_phone: finder,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        batch.set(ref, data);
        cache.found.set(fullNum, data);
        added++;
        
        // Check matches
        const key = `${suffix}_${isPlate}`;
        if (cache.missing.has(key)) {
            cache.missing.get(key).forEach(m => {
                matchesHTML += `<tr class="match-row"><td>${info.brand} - ${info.model}</td><td>${suffix}</td><td class="phone-owner">${m.owner_phone}</td><td class="phone-finder">${finder}</td></tr>`;
            });
        }
    }
    
    if (added > 0) await batch.commit();
    
    const time = ((Date.now() - start) / 1000).toFixed(1);
    document.getElementById('statSpeed').textContent = time + 's';
    setStatus(`âœ… Ø§Ù„Ù…Ø¶Ø§Ù: ${added} | Ø§Ù„Ù…ÙƒØ±Ø±: ${duplicates} | Ø§Ù„Ù…ØªØ¬Ø§Ù‡Ù„: ${skipped}`, '#28a745');
    setProgress(100, false);
    
    document.getElementById('matchesTable').innerHTML = matchesHTML || '<tr><td colspan="4" class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø·Ø§Ø¨Ù‚Ø§Øª</td></tr>';
    document.getElementById('uploadBtn').disabled = false;
    
    updateStats();
    loadPublicMatches();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Load Public Matches
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadPublicMatches() {
    const snap = await db.collection('confirmed_matches').orderBy('timestamp', 'desc').limit(50).get();
    let html = '';
    
    snap.forEach(d => {
        const data = d.data();
        const date = data.timestamp ? data.timestamp.toDate().toLocaleDateString('ar-EG') : '-';
        html += `<tr><td>${data.brand} - ${data.model}</td><td>${data.chassis_suffix}</td><td class="phone-owner">${data.owner_phone}</td><td class="phone-finder">${data.finder_phone}</td><td>${date}</td></tr>`;
    });
    
    document.getElementById('publicTable').innerHTML = html || '<tr><td colspan="5" class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø·Ø§Ø¨Ù‚Ø§Øª</td></tr>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Delete All Data
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function deleteAllData() {
    if (!auth.currentUser) {
        alert('âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
        return;
    }
    
    const code = prompt("âš ï¸ Ø±Ù…Ø² Ø§Ù„Ø­Ø°Ù:\n\nDELETE2026");
    if (code !== "DELETE2026") return alert("Ø±Ù…Ø² Ø®Ø§Ø·Ø¦");
    if (!confirm("ğŸš¨ Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ")) return;
    
    try {
        setStatus('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...');
        const cols = ['found_cars', 'missing_cars', 'confirmed_matches'];
        let total = 0;
        
        for (const col of cols) {
            const snap = await db.collection(col).get();
            for (const doc of snap.docs) {
                await doc.ref.delete();
                total++;
            }
        }
        
        cache.found.clear();
        cache.missing.clear();
        cache.loaded = false;
        
        alert(`âœ… ØªÙ… Ø­Ø°Ù ${total} Ø³Ø¬Ù„`);
        location.reload();
    } catch (e) {
        alert(`âŒ Ø®Ø·Ø£: ${e.message}\n\nØºÙŠÙ‘Ø± Firestore Rules:\nmatch /{document=**} { allow read, write: if true; }`);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Initialize (handled by auth.onAuthStateChanged)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
</script>
</body>
</html>
