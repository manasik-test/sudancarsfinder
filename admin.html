<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© v8.5</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        h2 { color: #1a73e8; border-bottom: 2px solid #1a73e8; padding-bottom: 10px; margin-bottom: 20px; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .stat-card { padding: 20px; border-radius: 12px; text-align: center; border: 1px solid transparent; }
        .stat-found { background: #e3f2fd; border-color: #1a73e8; color: #0d47a1; }
        .stat-missing { background: #fff3e0; border-color: #e67e22; color: #e65100; }
        .stat-speed { background: #e8f5e9; border-color: #4caf50; color: #2e7d32; }
        .stat-val { font-size: 28px; font-weight: bold; display: block; }
        .stat-label { font-size: 14px; }

        textarea { width: 100%; height: 160px; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 15px; margin-bottom: 15px; box-sizing: border-box; }
        .btn-main { background: #1a73e8; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 18px; font-weight: bold; transition: 0.3s; }
        .btn-clear { background: #dc3545; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 15px; font-weight: bold; }
        
        #status { text-align: center; margin: 15px 0; font-weight: bold; }
        .progress-bar { width: 100%; height: 25px; background: #e0e0e0; border-radius: 12px; overflow: hidden; margin: 10px 0; display: none; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #1a73e8, #4caf50); transition: width 0.3s; text-align: center; line-height: 25px; color: white; font-weight: bold; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 10% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px; box-shadow: 0 5px 30px rgba(0,0,0,0.3); }
        .modal-content h3 { color: #1a73e8; margin-bottom: 20px; }
        .modal-content select, .modal-content button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; font-size: 16px; }
        .modal-content button { background: #28a745; color: white; border: none; font-weight: bold; cursor: pointer; }
        .modal-content button.cancel { background: #6c757d; }
        
        .grid-tables { display: grid; grid-template-columns: 1fr; gap: 30px; margin-top: 20px; }
        .section { background: white; border-radius: 10px; overflow: hidden; border: 1px solid #ddd; }
        .upload-header { background: #0056b3; color: white; padding: 12px; font-weight: bold; }
        .public-header { background: #28a745; color: white; padding: 12px; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: right; }
        .match-found { background-color: #fff9c4; font-weight: bold; border-right: 5px solid #ffc107; }
        .owner-num { color: #d32f2f; font-weight: bold; }
        .finder-num { color: #1976d2; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸš€ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© - v8.5</h2>

    <div class="stats-grid">
        <div class="stat-card stat-found">
            <span class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø­ØµØ±</span>
            <span id="totalCarsCount" class="stat-val">0</span>
        </div>
        <div class="stat-card stat-missing">
            <span class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¨Ø­Ø« (Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø§Øª)</span>
            <span id="totalMissingCount" class="stat-val">0</span>
        </div>
        <div class="stat-card stat-speed">
            <span class="stat-label">Ø³Ø±Ø¹Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</span>
            <span id="speedStat" class="stat-val">--</span>
        </div>
    </div>
    
    <textarea id="rawInput" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù‡Ù†Ø§... Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…ÙƒØ±Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙˆØ§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø·Ø§Ø¨Ù‚Ø§Øª."></textarea>
    
    <button class="btn-main" onclick="processDataOptimized()">âš¡ Ø±ÙØ¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ù…Ø­Ø³Ù‘Ù†)</button>
    <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill">0%</div></div>
    <button class="btn-clear" onclick="clearData()">âš ï¸ Ù…Ø³Ø­ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    
    <div id="status"></div>

    <div class="grid-tables">
        <div class="section">
            <div class="upload-header">âš¡ Ù…Ø·Ø§Ø¨Ù‚Ø§Øª ÙÙˆØ±ÙŠØ© (Ø¸Ù‡Ø±Øª Ø§Ù„Ø¢Ù†)</div>
            <table>
                <thead><tr><th>Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th><th>Ø±Ù‚Ù… Ø§Ù„Ø´Ø§Ø³ÙŠ/Ø§Ù„Ù„ÙˆØ­Ø©</th><th>Ù‡Ø§ØªÙ ØµØ§Ø­Ø¨Ù‡Ø§</th><th>Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th></tr></thead>
                <tbody id="uploadMatchesBody"></tbody>
            </table>
        </div>

        <div class="section">
            <div class="public-header">ğŸ“± Ø³Ø¬Ù„ Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±</div>
            <table>
                <thead><tr><th>Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ù‡Ø§ØªÙ ØµØ§Ø­Ø¨Ù‡Ø§</th><th>Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead>
                <tbody id="publicMatchesBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="unknownModelModal" class="modal">
    <div class="modal-content">
        <h3>ğŸš— Ø§ÙƒØªØ´Ø§Ù Ù…ÙˆØ¯ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h3>
        <p>ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙˆØ¯ÙŠÙ„ ØºÙŠØ± Ù…Ø³Ø¬Ù„: <strong id="unknownModelName"></strong></p>
        <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©:</p>
        <select id="brandSelectModal"></select>
        <button onclick="saveUnknownModel()">Ø­ÙØ¸ ÙˆØ¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
        <button class="cancel" onclick="skipUnknownModel()">ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDvAx6-priGfzGLh2AlazSkIvsoc0OcW4Q",
        authDomain: "sudancarsrecover.firebaseapp.com",
        projectId: "sudancarsrecover",
        storageBucket: "sudancarsrecover.firebasestorage.app",
        messagingSenderId: "222129422162",
        appId: "1:222129422162:web:c3e8d3c498b53f96afc48b",
        measurementId: "G-YQ7JLMYF51"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let foundCarsCache = new Map();
    let missingCarsCache = new Map();
    let cacheLoaded = false;

    // Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø© ÙˆØ§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
    const carDict = {
        // 1. ØªÙˆÙŠÙˆØªØ§
        "ÙƒÙˆØ±ÙˆÙ„Ø§": "ØªÙˆÙŠÙˆØªØ§", "Ù…ÙˆÙ†ÙƒØ§": "ØªÙˆÙŠÙˆØªØ§", "ÙƒØ§Ù…Ø±ÙŠ": "ØªÙˆÙŠÙˆØªØ§", 
        "Ù„Ø§Ù†Ø¯ÙƒØ±ÙˆØ²Ø±": "ØªÙˆÙŠÙˆØªØ§", "ÙƒØ±ÙˆØ²Ø±": "ØªÙˆÙŠÙˆØªØ§", "Ø¨Ø±Ø§Ø¯Ùˆ": "ØªÙˆÙŠÙˆØªØ§", 
        "ÙÙˆØ±Ø´Ù†Ø±": "ØªÙˆÙŠÙˆØªØ§", "Ù‡Ø§ÙŠÙ„ÙˆÙƒØ³": "ØªÙˆÙŠÙˆØªØ§", "Ø¨ÙˆÙƒØ³ÙŠ": "ØªÙˆÙŠÙˆØªØ§", 
        "Ø¨ÙƒØ³ ØªØ§ÙŠÙˆØªØ§": "ØªÙˆÙŠÙˆØªØ§", "ÙŠØ§Ø±Ø³": "ØªÙˆÙŠÙˆØªØ§", "Ù‡Ø§ÙŠØ³": "ØªÙˆÙŠÙˆØªØ§", 
        "Ø´Ø±ÙŠØ­Ø©": "ØªÙˆÙŠÙˆØªØ§", "Ø±Ø§Ù ÙÙˆØ±": "ØªÙˆÙŠÙˆØªØ§", "Ø±Ø§Ù": "ØªÙˆÙŠÙˆØªØ§", "ÙƒÙˆØ³ØªØ±": "ØªÙˆÙŠÙˆØªØ§",
        
        // 2. Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ
        "Ø§ÙƒØ³Ù†Øª": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ù…Ø¶Ù„Ø¹": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø¯Ø¨Ø¯ÙˆØ¨": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø¬ÙŠØ§Ø¯": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ",
        "Ø£ÙØ§Ù†ØªÙŠ": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø§ÙØ§Ù†ØªÙŠ": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø³Ø­Ù„ÙŠØ©": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ù…Ù†ÙÙˆØ®Ø©": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ",
        "ÙÙŠØ±Ù†Ø§": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø§ÙŠ ØªÙ†": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø·ÙŠÙˆØ± Ø§Ù„Ø¬Ù†Ø©": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ù‚Ø±Ø§Ù†Ø¯": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ",
        "ÙƒÙ„Ùƒ": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ù‚ÙŠØªØ²": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "ØªÙˆØ³Ø§Ù†": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø³Ù†ØªØ§ÙÙŠ": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ",
        "Ø³ÙˆÙ†Ø§ØªØ§": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø¥Ù„Ù†ØªØ±Ø§": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø§Ù„Ù†ØªØ±Ø§": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø³ØªØ§Ø±ÙŠÙƒØ³": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ",
        "Ø§ØªØ´ ÙˆÙ†": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø¬Ø±ÙŠØ³": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "ÙƒØ±ÙŠØ²": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø§ÙŠÙˆÙ†": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ",
        "Ø§ÙŠ ØªÙˆÙ†ØªÙŠ": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø§ÙŠ Ø«ÙŠØ±ØªÙŠ": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ù…Ø§ØªØ±ÙƒØ³": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", 
        "Ù„Ø§ÙÙŠØªØ§": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø¨ÙˆØ±ØªØ± Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø§ØªÙˆØ³": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "Ø§ØªØ³": "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ",
        
        // 3. ÙƒÙŠØ§
        "Ù…ÙˆØ±Ù†ÙŠÙ‚": "ÙƒÙŠØ§", "Ø¨ÙŠÙƒØ§Ù†ØªÙˆ": "ÙƒÙŠØ§", "Ø±ÙŠÙˆ": "ÙƒÙŠØ§", "Ø³ÙŠØ±Ø§ØªÙˆ": "ÙƒÙŠØ§",
        "Ø³ÙˆØ±Ù†ØªÙˆ": "ÙƒÙŠØ§", "Ø³Ø¨ÙˆØ±ØªØ¬": "ÙƒÙŠØ§", "Ø§ÙˆØ¨ØªÙ…Ø§": "ÙƒÙŠØ§", "ÙÙŠØ³ØªÙˆ": "ÙƒÙŠØ§",
        "Ø£Ù…Ø¬Ø§Ø¯ ÙƒÙŠØ§": "ÙƒÙŠØ§",
        
        // 4. Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ
        "Ù„Ø§Ù†Ø³Ø±": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ", "Ø¨ÙˆÙ…Ø©": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ", "Ù‚Ø±Ø´": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ", 
        "Ø¨Ø§Ø¬ÙŠØ±Ùˆ": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ", "Ø§ØªØ±Ø§Ø¬": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ", "Ø§ÙˆØªÙ„Ø§Ù†Ø¯Ø±": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ", 
        "Ù…ÙŠØ±Ø§Ø¬": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ", "L300": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ", "ÙƒØ§Ù†ØªØ±": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ", 
        "Ø¯ÙØ§Ø± Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ", "Ø¨ÙƒØ³ Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ": "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ",
        
        // 5. Ù†ÙŠØ³Ø§Ù†
        "ØµÙ†ÙŠ": "Ù†ÙŠØ³Ø§Ù†", "Ø³Ù†ØªØ±Ø§": "Ù†ÙŠØ³Ø§Ù†", "ØªÙŠØ¯Ø§": "Ù†ÙŠØ³Ø§Ù†", "Ø¨Ø§ØªØ±ÙˆÙ„": "Ù†ÙŠØ³Ø§Ù†",
        "Ù…ÙˆØ±Ø§Ù†Ùˆ": "Ù†ÙŠØ³Ø§Ù†", "Ø§ÙƒØ³ ØªØ±ÙŠÙ„": "Ù†ÙŠØ³Ø§Ù†", "Ù„Ø§ÙÙŠÙ†Ø§": "Ù†ÙŠØ³Ø§Ù†", 
        "Ø¨ÙŠÙƒ Ø£Ø¨ Ù†ÙŠØ³Ø§Ù†": "Ù†ÙŠØ³Ø§Ù†", "Ø¨ÙƒØ³ Ù†ÙŠØ³Ø§Ù†": "Ù†ÙŠØ³Ø§Ù†",
        
        // 6. Ø³ÙˆØ²ÙˆÙƒÙŠ
        "Ø£Ù„ØªÙˆ": "Ø³ÙˆØ²ÙˆÙƒÙŠ", "Ø§Ù„ØªÙˆ": "Ø³ÙˆØ²ÙˆÙƒÙŠ", "ÙÙŠØªØ§Ø±Ø§": "Ø³ÙˆØ²ÙˆÙƒÙŠ", 
        "Ø³ÙˆØ²ÙˆÙƒÙŠ ÙØ§Ù†": "Ø³ÙˆØ²ÙˆÙƒÙŠ", "Ø£Ù…Ø¬Ø§Ø¯": "Ø³ÙˆØ²ÙˆÙƒÙŠ", "Ø§Ù…Ø¬Ø§Ø¯": "Ø³ÙˆØ²ÙˆÙƒÙŠ",
        
        // 7. ÙÙˆÙ„ÙƒØ³ ÙØ§Ø¬Ù†
        "Ø¨Ø§Ø³Ø§Øª": "ÙÙˆÙ„ÙƒØ³ ÙØ§Ø¬Ù†", "Ø¨ÙˆÙ„Ùˆ": "ÙÙˆÙ„ÙƒØ³ ÙØ§Ø¬Ù†", "Ø¨ÙˆØ±Ø§": "ÙÙˆÙ„ÙƒØ³ ÙØ§Ø¬Ù†",
        
        // 8. Ù‡ÙˆÙ†Ø¯Ø§
        "Ø³ÙŠÙÙŠÙƒ": "Ù‡ÙˆÙ†Ø¯Ø§", "Ø³ÙŠØªÙŠ": "Ù‡ÙˆÙ†Ø¯Ø§",
        
        // 9. Ø³ÙƒÙˆØ¯Ø§
        "ÙØ§Ø¨ÙŠØ§": "Ø³ÙƒÙˆØ¯Ø§", "Ø§ÙˆÙƒØªØ§ÙÙŠØ§": "Ø³ÙƒÙˆØ¯Ø§", "Ø³ÙŠØ¨Ø±ÙŠÙˆØ±": "Ø³ÙƒÙˆØ¯Ø§",
        
        // 10. Ø¨ÙŠ ÙˆØ§ÙŠ Ø¯ÙŠ
        "Ø¨ÙŠ ÙˆØ§ÙŠ Ø¯ÙŠ ØµØ§Ù„ÙˆÙ†": "Ø¨ÙŠ ÙˆØ§ÙŠ Ø¯ÙŠ", "Ø¨ÙŠ ÙˆØ§ÙŠ Ø¯ÙŠ Ø§Ø³ØªÙŠØ´Ù†": "Ø¨ÙŠ ÙˆØ§ÙŠ Ø¯ÙŠ", 
        "Ø¨ÙŠ ÙˆØ§ÙŠ Ø¯ÙŠ ØªÙƒØ³ÙŠ": "Ø¨ÙŠ ÙˆØ§ÙŠ Ø¯ÙŠ", "ØªÙƒØ³ÙŠ Ø¨ÙŠ ÙˆØ§ÙŠ Ø¯ÙŠ": "Ø¨ÙŠ ÙˆØ§ÙŠ Ø¯ÙŠ",
        
        // 11. ØªØ§ØªØ§
        "ØªØ§ØªØ§ Ø¨ÙƒØ³": "ØªØ§ØªØ§", "ØªØ§ØªØ§ Ø¨Øµ": "ØªØ§ØªØ§", "ØªØ§ØªØ§ Ø¯ÙØ§Ø±": "ØªØ§ØªØ§", 
        "ØªØ§ØªØ§ Ø¨ÙˆØ±ØªØ±": "ØªØ§ØªØ§", "Ø¨ÙˆØ±ØªØ± ØªØ§ØªØ§": "ØªØ§ØªØ§",
        
        // 12. Ø±Ø£Ø³ Ø´Ø§Ø­Ù†Ø©
        "ÙÙˆÙ„ÙÙˆ": "Ø±Ø£Ø³ Ø´Ø§Ø­Ù†Ø©", "Ù…Ø±Ø³ÙŠØ¯Ø³ Ø´Ø§Ø­Ù†Ø©": "Ø±Ø£Ø³ Ø´Ø§Ø­Ù†Ø©", "Ù…Ø§Ù†": "Ø±Ø£Ø³ Ø´Ø§Ø­Ù†Ø©",
        "Ù‡ÙŠÙ†Ùˆ": "Ø±Ø£Ø³ Ø´Ø§Ø­Ù†Ø©", "Ø±Ø£Ø³ Ø´Ø§Ø­Ù†Ø© ØµÙŠÙ†ÙŠ": "Ø±Ø£Ø³ Ø´Ø§Ø­Ù†Ø©", "Ø´Ø§Ø­Ù†Ø© ØµÙŠÙ†ÙŠ": "Ø±Ø£Ø³ Ø´Ø§Ø­Ù†Ø©",
        "Ø±ÙŠÙ†Ùˆ Ø´Ø§Ø­Ù†Ø©": "Ø±Ø£Ø³ Ø´Ø§Ø­Ù†Ø©", "Ø§Ø³ÙƒØ§Ù†ÙŠØ§": "Ø±Ø£Ø³ Ø´Ø§Ø­Ù†Ø©", "Ø¯Ø§Ù": "Ø±Ø£Ø³ Ø´Ø§Ø­Ù†Ø©",
        
        // 13. Ø§ÙŠØ³ÙˆØ²Ùˆ
        "Ø§ÙŠØ³ÙˆØ²Ùˆ Ø¯ÙØ§Ø±": "Ø§ÙŠØ³ÙˆØ²Ùˆ", "Ø¯ÙØ§Ø± Ø§ÙŠØ³ÙˆØ²Ùˆ": "Ø§ÙŠØ³ÙˆØ²Ùˆ", "Ø§ÙŠØ³ÙˆØ²Ùˆ Ø¨ÙƒØ³": "Ø§ÙŠØ³ÙˆØ²Ùˆ",
        "Ø¨ÙƒØ³ Ø§ÙŠØ³ÙˆØ²Ùˆ": "Ø§ÙŠØ³ÙˆØ²Ùˆ", "Ø§ÙŠØ³ÙˆØ²Ùˆ ØµØ§Ù„ÙˆÙ†": "Ø§ÙŠØ³ÙˆØ²Ùˆ", "Ø§ÙŠØ³ÙˆØ²Ùˆ Ø§Ø³ØªÙŠØ´Ù†": "Ø§ÙŠØ³ÙˆØ²Ùˆ",
        
        // Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰
        "Ù…Ø±Ø³ÙŠØ¯Ø³": "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰", "Ø¨ÙŠ Ø§Ù… Ø¯Ø¨Ù„ÙŠÙˆ": "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰", 
        "Ø´ÙØ±ÙˆÙ„ÙŠÙ‡": "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰", "Ø¬ÙŠÙ„ÙŠ": "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰", 
        "Ù…Ø§Ø²Ø¯Ø§": "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰", "Ø§Ù… Ø¬ÙŠ": "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰", 
        "Ø¯Ø§ÙŠÙˆ": "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰", "Ù†ÙˆØ¨ÙŠØ±Ø§": "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰", "Ø¯Ø§Ù…Ø§Ø³": "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰"
    };

    const brandsList = [
        "ØªÙˆÙŠÙˆØªØ§", "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "ÙƒÙŠØ§", "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ", "Ù†ÙŠØ³Ø§Ù†", "Ø³ÙˆØ²ÙˆÙƒÙŠ",
        "ÙÙˆÙ„ÙƒØ³ ÙØ§Ø¬Ù†", "Ù‡ÙˆÙ†Ø¯Ø§", "Ø³ÙƒÙˆØ¯Ø§", "Ø¨ÙŠ ÙˆØ§ÙŠ Ø¯ÙŠ", "ØªØ§ØªØ§", 
        "Ø±Ø£Ø³ Ø´Ø§Ø­Ù†Ø©", "Ø§ÙŠØ³ÙˆØ²Ùˆ", "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰"
    ];

    let currentUnknownModel = "";
    let unknownModelResolver = null;

    function normalizeChassisNumber(fullNum, isPlate) {
        if (isPlate) return fullNum;
        if (fullNum.length >= 4) return fullNum.slice(-4);
        if (fullNum.length > 0) return fullNum.padStart(4, '0');
        return fullNum;
    }

    async function loadCache() {
        if (cacheLoaded) return;
        const [foundSnap, missingSnap] = await Promise.all([
            db.collection('found_cars').get(),
            db.collection('missing_cars').get()
        ]);
        foundSnap.forEach(doc => {
            const data = doc.data();
            foundCarsCache.set(data.chassis_full, { id: doc.id, ...data });
        });
        missingSnap.forEach(doc => {
            const data = doc.data();
            const key = `${data.chassis_suffix}_${data.is_plate}`;
            if (!missingCarsCache.has(key)) missingCarsCache.set(key, []);
            missingCarsCache.get(key).push({ id: doc.id, ...data });
        });
        cacheLoaded = true;
    }

    function updateStatsFromCache() {
        document.getElementById('totalCarsCount').innerText = foundCarsCache.size;
        document.getElementById('totalMissingCount').innerText = 
            Array.from(missingCarsCache.values()).reduce((sum, arr) => sum + arr.length, 0);
    }

    function findModelInText(line) {
        const lowerLine = line.toLowerCase();
        for (let model in carDict) {
            if (lowerLine.includes(model.toLowerCase())) {
                return { model: model, brand: carDict[model] };
            }
        }
        return null;
    }

    function extractPossibleModel(line) {
        const words = line.match(/[a-zA-ZØ¡-ÙŠ]+/g);
        if (words && words.length > 0) {
            for (let word of words) {
                if (word.length >= 3 && !['Ø´Ø§Ø³ÙŠ', 'Ù„ÙˆØ­Ø©', 'Ù„ÙˆØ­Ù‡', 'Ø±Ù‚Ù…'].includes(word)) {
                    return word;
                }
            }
        }
        return "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
    }

    function showUnknownModelDialog(modelName) {
        return new Promise((resolve) => {
            currentUnknownModel = modelName;
            unknownModelResolver = resolve;
            
            document.getElementById('unknownModelName').textContent = modelName;
            
            const select = document.getElementById('brandSelectModal');
            select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø±ÙƒØ© --</option>';
            brandsList.forEach(brand => {
                const opt = document.createElement('option');
                opt.value = brand;
                opt.textContent = brand;
                select.appendChild(opt);
            });
            
            document.getElementById('unknownModelModal').style.display = 'block';
        });
    }

    function saveUnknownModel() {
        const selectedBrand = document.getElementById('brandSelectModal').value;
        if (!selectedBrand) {
            alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø±ÙƒØ©');
            return;
        }
        
        carDict[currentUnknownModel] = selectedBrand;
        document.getElementById('unknownModelModal').style.display = 'none';
        
        if (unknownModelResolver) {
            unknownModelResolver({ model: currentUnknownModel, brand: selectedBrand });
        }
    }

    function skipUnknownModel() {
        document.getElementById('unknownModelModal').style.display = 'none';
        if (unknownModelResolver) {
            unknownModelResolver(null);
        }
    }

    async function processDataOptimized() {
        const startTime = Date.now();
        const text = document.getElementById('rawInput').value;
        const lines = text.split('\n').filter(l => l.trim());
        
        if (lines.length === 0) {
            alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            return;
        }

        document.getElementById('progressBar').style.display = 'block';
        document.getElementById('uploadMatchesBody').innerHTML = "";
        document.getElementById('status').innerHTML = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„Ù„Ø°Ø§ÙƒØ±Ø©...";
        
        await loadCache();

        let uploaded = 0, duplicates = 0, skipped = 0;
        let globalFinder = "ØºÙŠØ± Ù…Ø³Ø¬Ù„";
        let matchesHTML = "";

        for (let line of lines) {
            let phones = line.match(/(0[19]\d{8,})/g);
            if (phones) { globalFinder = phones[0]; break; }
        }

        document.getElementById('status').innerHTML = "âš¡ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©...";

        const batch = db.batch();

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            
            const progress = Math.round(((i + 1) / lines.length) * 100);
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressFill').innerText = progress + '%';

            let allNums = line.match(/\d+/g);
            if (!allNums) continue;
            
            let fullNum = allNums.reduce((a, b) => a.length > b.length ? a : b);
            if (fullNum.length < 1) {
                skipped++;
                continue;
            }
            
            let isPlate = /Ù„ÙˆØ­Ù‡|Ù„ÙˆØ­Ø©/.test(line);
            let suffix = normalizeChassisNumber(fullNum, isPlate);

            let modelInfo = findModelInText(line);
            
            if (!modelInfo) {
                const possibleModel = extractPossibleModel(line);
                document.getElementById('status').innerHTML = `â¸ï¸ Ù…ÙˆØ¯ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ: ${possibleModel}`;
                
                modelInfo = await showUnknownModelDialog(possibleModel);
                
                if (!modelInfo) {
                    skipped++;
                    continue;
                }
            }

            const { model, brand } = modelInfo;

            if (!foundCarsCache.has(fullNum)) {
                const newCarRef = db.collection('found_cars').doc();
                const carData = {
                    brand, 
                    model,
                    chassis_full: fullNum,
                    chassis_suffix: suffix,
                    is_plate: isPlate,
                    finder_phone: globalFinder,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                batch.set(newCarRef, carData);
                foundCarsCache.set(fullNum, { id: newCarRef.id, ...carData });
                uploaded++;

                const matchKey = `${suffix}_${isPlate}`;
                if (missingCarsCache.has(matchKey)) {
                    missingCarsCache.get(matchKey).forEach(m => {
                        matchesHTML += `<tr class="match-found"><td>${brand}-${model}</td><td>${suffix}</td><td class="owner-num">${m.owner_phone}</td><td class="finder-num">${globalFinder}</td></tr>`;
                    });
                }
            } else {
                duplicates++;
            }
        }

        if (uploaded > 0) {
            await batch.commit();
        }

        const endTime = Date.now();
        const timeTaken = ((endTime - startTime) / 1000).toFixed(2);
        
        document.getElementById('progressBar').style.display = 'none';
        
        let statusMsg = `âœ… Ø§Ù„Ù…Ø¶Ø§Ù: ${uploaded} | âš ï¸ Ø§Ù„Ù…ÙƒØ±Ø±: ${duplicates}`;
        if (skipped > 0) statusMsg += ` | ğŸš« Ø§Ù„Ù…ØªØ¬Ø§Ù‡Ù„: ${skipped}`;
        statusMsg += ` | â±ï¸ Ø§Ù„ÙˆÙ‚Øª: ${timeTaken} Ø«Ø§Ù†ÙŠØ©`;
        
        document.getElementById('status').innerHTML = statusMsg;
        document.getElementById('speedStat').innerText = `${timeTaken}s`;
        document.getElementById('uploadMatchesBody').innerHTML = matchesHTML || '<tr><td colspan="4" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø·Ø§Ø¨Ù‚Ø§Øª</td></tr>';
        
        updateStatsFromCache();
        loadPublic();
    }

    async function loadPublic() {
        const snap = await db.collection('confirmed_matches').orderBy('timestamp', 'desc').limit(100).get();
        let h = "";
        snap.forEach(d => {
            const data = d.data();
            const date = data.timestamp ? data.timestamp.toDate().toLocaleDateString('ar-EG') : '-';
            h += `<tr><td>${data.brand}-${data.model}</td><td>${data.chassis_suffix}</td><td class="owner-num">${data.owner_phone}</td><td class="finder-num">${data.finder_phone}</td><td>${date}</td></tr>`;
        });
        document.getElementById('publicMatchesBody').innerHTML = h || '<tr><td colspan="5" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ø¨Ø¹Ø¯</td></tr>';
    }

    async function clearData() {
        if (!confirm("ğŸš¨ ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ")) return;
        document.getElementById('status').innerHTML = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­...";
        const cols = ['found_cars', 'missing_cars', 'confirmed_matches'];
        for (const col of cols) {
            const snap = await db.collection(col).get();
            const batch = db.batch();
            snap.forEach(d => batch.delete(d.ref));
            await batch.commit();
        }
        foundCarsCache.clear();
        missingCarsCache.clear();
        cacheLoaded = false;
        alert("âœ… ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ³ Ø¨Ù†Ø¬Ø§Ø­");
        location.reload();
    }

    window.onload = async () => { 
        await loadPublic();
        await loadCache();
        updateStatsFromCache();
    };
</script>
</body>
</html>
