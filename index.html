<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­Ø³Ù‘Ù† - Ø§Ù„Ø³ÙˆØ¯Ø§Ù†</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f2f5; padding: 15px; text-align: center; }
        .card { max-width: 450px; margin: auto; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h2 { color: #1a73e8; margin-bottom: 20px; }
        select, input, button { width: 100%; padding: 14px; margin: 10px 0; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; box-sizing: border-box; }
        button { background: #28a745; color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background: #218838; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .type-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .type-btn { flex: 1; padding: 12px; background: #eee; border-radius: 8px; cursor: pointer; font-size: 14px; border: 2px solid transparent; transition: 0.2s; }
        input[type="radio"] { display: none; }
        .type-btn:has(input:checked) { border-color: #1a73e8; background: #e3f2fd; font-weight: bold; }
        #msg { display: none; padding: 15px; border-radius: 10px; margin-top: 15px; font-weight: bold; line-height: 1.6; }
        .found { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .not-found { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .spinner { display: none; margin: 10px auto; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #1a73e8; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø³ÙŠØ§Ø±ØªÙƒ (Ù…Ø­Ø³Ù‘Ù†)</h2>
    
    <div class="type-selector">
        <label class="type-btn"><input type="radio" name="searchType" value="chassis" checked><span>Ø±Ù‚Ù… Ø´Ø§Ø³ÙŠ (4 Ø£Ø±Ù‚Ø§Ù…)</span></label>
        <label class="type-btn"><input type="radio" name="searchType" value="plate"><span>Ø±Ù‚Ù… Ù„ÙˆØ­Ø© (ÙƒØ§Ù…Ù„)</span></label>
    </div>

    <select id="brandSelect" onchange="updateModels()">
        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø±ÙƒØ© --</option>
    </select>

    <select id="modelSelect">
        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ --</option>
    </select>

    <input type="text" id="suffix" placeholder="Ø£Ø¯Ø®Ù„ Ø¢Ø®Ø± 4 Ø£Ø±Ù‚Ø§Ù… Ù…Ù† Ø§Ù„Ø´Ø§Ø³ÙŠ">
    <input type="tel" id="phone" placeholder="Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ (Ù„Ù„ØªÙˆØ§ØµÙ„)">

    <button id="searchBtn" onclick="startSearchOptimized()">âš¡ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹</button>
    <div class="spinner" id="spinner"></div>
    <div id="msg"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDvAx6-priGfzGLh2AlazSkIvsoc0OcW4Q",
        authDomain: "sudancarsrecover.firebaseapp.com",
        projectId: "sudancarsrecover",
        storageBucket: "sudancarsrecover.firebasestorage.app",
        messagingSenderId: "222129422162",
        appId: "1:222129422162:web:c3e8d3c498b53f96afc48b",
        measurementId: "G-YQ7JLMYF51"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ØªÙØ¹ÙŠÙ„ Persistence Ù„Ù„Ø¹Ù…Ù„ Offline
    db.enablePersistence({ synchronizeTabs: true })
        .catch(err => console.log("Persistence error:", err.code));

    const carData = {
        "ØªÙˆÙŠÙˆØªØ§": ["ÙƒÙˆØ±ÙˆÙ„Ø§ (Ù…ÙˆÙ†ÙƒØ§)", "ÙƒØ§Ù…Ø±ÙŠ", "Ù„Ø§Ù†Ø¯ÙƒØ±ÙˆØ²Ø± (GXR)", "Ø¨Ø±Ø§Ø¯Ùˆ", "Ù‡Ø§ÙŠÙ„ÙˆÙƒØ³ (Ø¨ÙˆÙƒØ³ÙŠ)", "Ù‡Ø§ÙŠØ³ (Ø´Ø±ÙŠØ­Ø©)"],
        "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ": ["Ø§ÙƒØ³Ù†Øª (Ù…Ø¶Ù„Ø¹/Ø¯Ø¨Ø¯ÙˆØ¨/Ø¬ÙŠØ§Ø¯)", "Ø£ÙØ§Ù†ØªÙŠ (Ø³Ø­Ù„ÙŠØ©/Ù…Ù†ÙÙˆØ®Ø©)", "ØªÙˆØ³Ø§Ù†", "Ø³Ù†ØªØ§ÙÙŠ", "Ø³ÙˆÙ†Ø§ØªØ§", "Ø¥Ù„Ù†ØªØ±Ø§", "Ø§ØªÙˆØ³"],
        "ÙƒÙŠØ§": ["Ù…ÙˆØ±Ù†ÙŠÙ‚", "Ø¨ÙŠÙƒØ§Ù†ØªÙˆ", "Ø±ÙŠÙˆ", "Ø³ÙŠØ±Ø§ØªÙˆ", "Ø³ÙˆØ±Ù†ØªÙˆ", "Ø³Ø¨ÙˆØ±ØªØ¬"],
        "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ": ["Ù„Ø§Ù†Ø³Ø± (Ø¨ÙˆÙ…Ø©/Ù‚Ø±Ø´)", "Ø¨Ø§Ø¬ÙŠØ±Ùˆ", "ÙƒØ§Ù†ØªØ± (Ø¯ÙØ§Ø±)"],
        "Ø³ÙˆØ²ÙˆÙƒÙŠ": ["Ø£Ù„ØªÙˆ", "ÙÙŠØªØ§Ø±Ø§", "Ø³ÙˆØ²ÙˆÙƒÙŠ ÙØ§Ù† (Ø£Ù…Ø¬Ø§Ø¯)"],
        "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰": ["Ù…Ø±Ø³ÙŠØ¯Ø³", "Ø¨ÙŠ Ø§Ù… Ø¯Ø¨Ù„ÙŠÙˆ", "Ø´ÙØ±ÙˆÙ„ÙŠÙ‡", "Ø¬ÙŠÙ„ÙŠ", "Ø¯Ø§ÙŠÙˆ", "Ø¥ÙŠØ³ÙˆØ²Ùˆ"]
    };

    const suffixInput = document.getElementById('suffix');
    const typeButtons = document.querySelectorAll('input[name="searchType"]');
    const searchBtn = document.getElementById('searchBtn');
    const spinner = document.getElementById('spinner');

    // Cache Ø¨Ø³ÙŠØ· Ù„Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø£Ø®ÙŠØ±Ø©
    const searchCache = new Map();
    const CACHE_DURATION = 60000; // Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©

    typeButtons.forEach(btn => {
        btn.addEventListener('change', () => {
            suffixInput.value = "";
            if (btn.value === 'chassis') {
                suffixInput.placeholder = "Ø£Ø¯Ø®Ù„ Ø¢Ø®Ø± 4 Ø£Ø±Ù‚Ø§Ù… Ù…Ù† Ø§Ù„Ø´Ø§Ø³ÙŠ";
                suffixInput.maxLength = 4;
            } else {
                suffixInput.placeholder = "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø© (Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·)";
                suffixInput.maxLength = 10;
            }
        });
    });

    suffixInput.addEventListener('input', (e) => {
        suffixInput.value = suffixInput.value.replace(/[^0-9]/g, '');
    });

    function init() {
        const brandSelect = document.getElementById('brandSelect');
        for (let brand in carData) {
            let opt = document.createElement('option');
            opt.value = brand; 
            opt.innerHTML = brand;
            brandSelect.appendChild(opt);
        }
        suffixInput.maxLength = 4;
    }

    function updateModels() {
        const brand = document.getElementById('brandSelect').value;
        const modelSelect = document.getElementById('modelSelect');
        modelSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ --</option>';
        if (brand && carData[brand]) {
            carData[brand].forEach(m => {
                let opt = document.createElement('option');
                opt.value = m; 
                opt.innerHTML = m;
                modelSelect.appendChild(opt);
            });
        }
    }

    async function startSearchOptimized() {
        const brand = document.getElementById('brandSelect').value;
        const model = document.getElementById('modelSelect').value;
        const suffix = suffixInput.value.trim();
        const phone = document.getElementById('phone').value.trim();
        const isPlate = document.querySelector('input[name="searchType"]:checked').value === 'plate';
        const msgDiv = document.getElementById('msg');

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if(!brand || !model || suffix === "" || !phone) { 
            alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); 
            return; 
        }
        if(!isPlate && suffix.length !== 4) { 
            alert("ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ 4 Ø£Ø±Ù‚Ø§Ù… Ù„Ù„Ø´Ø§Ø³ÙŠ"); 
            return; 
        }

        // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± ÙˆØ¥Ø¸Ù‡Ø§Ø± Spinner
        searchBtn.disabled = true;
        spinner.style.display = 'block';
        msgDiv.style.display = 'none';

        const cacheKey = `${suffix}_${isPlate}`;
        const now = Date.now();

        try {
            // ÙØ­Øµ Ø§Ù„ÙƒØ§Ø´ Ø£ÙˆÙ„Ø§Ù‹
            if (searchCache.has(cacheKey)) {
                const cached = searchCache.get(cacheKey);
                if (now - cached.timestamp < CACHE_DURATION) {
                    await processSearchResult(cached.data, brand, model, suffix, phone, isPlate, msgDiv);
                    searchBtn.disabled = false;
                    spinner.style.display = 'none';
                    return;
                }
            }

            // Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù…Ø­Ø³Ù‘Ù† Ù…Ø¹ Index
            const snapshot = await db.collection('found_cars')
                .where('chassis_suffix', '==', suffix)
                .where('is_plate', '==', isPlate)
                .limit(1) // Ù†Ø­ØªØ§Ø¬ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·
                .get();

            // Ø­ÙØ¸ ÙÙŠ Ø§Ù„ÙƒØ§Ø´
            searchCache.set(cacheKey, {
                data: snapshot,
                timestamp: now
            });

            await processSearchResult(snapshot, brand, model, suffix, phone, isPlate, msgDiv);

        } catch (error) {
            console.error("Search error:", error);
            msgDiv.style.display = 'block';
            msgDiv.className = "msg not-found";
            msgDiv.innerHTML = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
        } finally {
            searchBtn.disabled = false;
            spinner.style.display = 'none';
        }
    }

    async function processSearchResult(snapshot, brand, model, suffix, phone, isPlate, msgDiv) {
        msgDiv.style.display = 'block';

        if (!snapshot.empty) {
            let foundData = snapshot.docs[0].data();
            msgDiv.className = "msg found";
            msgDiv.innerHTML = `âœ… Ø£Ø¨Ø´Ø±! Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©. Ø³Ù†ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ù„ÙƒÙŠØ©`;
            
            // Ø­ÙØ¸ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
            await db.collection('confirmed_matches').add({ 
                brand, 
                model, 
                chassis_suffix: suffix, 
                is_plate: isPlate, 
                owner_phone: phone, 
                finder_phone: foundData.finder_phone, 
                timestamp: firebase.firestore.FieldValue.serverTimestamp() 
            });
        } else {
            msgDiv.className = "msg not-found";
            msgDiv.innerHTML = "ğŸ”” Ù„Ù… ØªØ¸Ù‡Ø± Ø¨Ø¹Ø¯. ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ÙˆØ³Ù†Ø®Ø·Ø±Ùƒ ÙÙˆØ± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡Ø§.";
            
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯
            await db.collection('missing_cars').add({ 
                brand, 
                model, 
                chassis_suffix: suffix, 
                is_plate: isPlate, 
                owner_phone: phone, 
                timestamp: firebase.firestore.FieldValue.serverTimestamp() 
            });
        }
    }

    init();
</script>
</body>
</html>
