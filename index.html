<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø´Ø§Ù…Ù„ v8.0</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f2f5; padding: 15px; text-align: center; }
        .card { max-width: 500px; margin: auto; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h2 { color: #1a73e8; margin-bottom: 20px; }
        
        select, input, button { width: 100%; padding: 14px; margin: 10px 0; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; box-sizing: border-box; }
        button { background: #28a745; color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background: #218838; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        .type-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .type-btn { flex: 1; padding: 12px; background: #eee; border-radius: 8px; cursor: pointer; font-size: 14px; border: 2px solid transparent; transition: 0.2s; }
        input[type="radio"] { display: none; }
        .type-btn:has(input:checked) { border-color: #1a73e8; background: #e3f2fd; font-weight: bold; }
        
        #msg { display: none; padding: 15px; border-radius: 10px; margin-top: 15px; font-weight: bold; line-height: 1.6; }
        .found { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .not-found { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        
        .spinner { display: none; margin: 10px auto; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #1a73e8; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .input-helper { font-size: 13px; color: #d32f2f; text-align: right; margin-top: -8px; margin-bottom: 10px; font-weight: bold; }
        
        .info-box { background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 12px; margin-bottom: 15px; text-align: right; font-size: 14px; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø³ÙŠØ§Ø±ØªÙƒ (v8.0)</h2>
    
    <div class="info-box">
        âš ï¸ <strong>Ù…Ù‡Ù…:</strong> ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ <strong>4 Ø£Ø±Ù‚Ø§Ù… Ø¨Ø§Ù„Ø¶Ø¨Ø·</strong> Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø´Ø§Ø³ÙŠ
    </div>
    
    <div class="type-selector">
        <label class="type-btn"><input type="radio" name="searchType" value="chassis" checked><span>Ø±Ù‚Ù… Ø´Ø§Ø³ÙŠ (4 Ø£Ø±Ù‚Ø§Ù…)</span></label>
        <label class="type-btn"><input type="radio" name="searchType" value="plate"><span>Ø±Ù‚Ù… Ù„ÙˆØ­Ø©</span></label>
    </div>

    <select id="brandSelect" onchange="updateModels()">
        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø±ÙƒØ© --</option>
    </select>

    <select id="modelSelect">
        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ --</option>
    </select>

    <input type="text" id="suffix" placeholder="Ø£Ø¯Ø®Ù„ Ø¢Ø®Ø± 4 Ø£Ø±Ù‚Ø§Ù… Ù…Ù† Ø§Ù„Ø´Ø§Ø³ÙŠ" maxlength="4">
    <div class="input-helper" id="inputHelper">âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ 4 Ø£Ø±Ù‚Ø§Ù… Ø¨Ø§Ù„Ø¶Ø¨Ø·</div>
    
    <input type="tel" id="phone" placeholder="Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ (Ù„Ù„ØªÙˆØ§ØµÙ„)">

    <button id="searchBtn" onclick="startSearchOptimized()">âš¡ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø«</button>
    <div class="spinner" id="spinner"></div>
    <div id="msg"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDvAx6-priGfzGLh2AlazSkIvsoc0OcW4Q",
        authDomain: "sudancarsrecover.firebaseapp.com",
        projectId: "sudancarsrecover",
        storageBucket: "sudancarsrecover.firebasestorage.app",
        messagingSenderId: "222129422162",
        appId: "1:222129422162:web:c3e8d3c498b53f96afc48b",
        measurementId: "G-YQ7JLMYF51"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    db.enablePersistence({ synchronizeTabs: true })
        .catch(err => console.log("Persistence error:", err.code));

    // Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª
    const carData = {
        "ØªÙˆÙŠÙˆØªØ§": [
            "ÙƒÙˆØ±ÙˆÙ„Ø§ (Ù…ÙˆÙ†ÙƒØ§)", "ÙƒØ§Ù…Ø±ÙŠ", "Ù„Ø§Ù†Ø¯ÙƒØ±ÙˆØ²Ø± (GXR/ÙƒØ±ÙˆØ²Ø±)", "Ø¨Ø±Ø§Ø¯Ùˆ", "ÙÙˆØ±Ø´Ù†Ø±",
            "Ù‡Ø§ÙŠÙ„ÙˆÙƒØ³ (Ø¨ÙˆÙƒØ³ÙŠ/Ø¨ÙƒØ³)", "ÙŠØ§Ø±Ø³", "Ù‡Ø§ÙŠØ³ (Ø´Ø±ÙŠØ­Ø©)", "Ø±Ø§Ù ÙÙˆØ± (RAV4)", "ÙƒÙˆØ³ØªØ±"
        ],
        "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ": [
            "Ø§ÙƒØ³Ù†Øª (Ù…Ø¶Ù„Ø¹/Ø¯Ø¨Ø¯ÙˆØ¨/Ø¬ÙŠØ§Ø¯)", "Ø£ÙØ§Ù†ØªÙŠ (Ø³Ø­Ù„ÙŠØ©/Ù…Ù†ÙÙˆØ®Ø©)", "ÙÙŠØ±Ù†Ø§",
            "Ø§ÙŠ ØªÙ† (i10/Ø·ÙŠÙˆØ± Ø§Ù„Ø¬Ù†Ø©)", "ÙƒÙ„Ùƒ/Ù‚ÙŠØªØ² (Click/Getz)", "ØªÙˆØ³Ø§Ù†", "Ø³Ù†ØªØ§ÙÙŠ",
            "Ø³ÙˆÙ†Ø§ØªØ§", "Ø¥Ù„Ù†ØªØ±Ø§", "Ø³ØªØ§Ø±ÙŠÙƒØ³/Ø§ØªØ´ ÙˆÙ† (H1)", "Ø¬Ø±ÙŠØ³ (ÙƒØ±ÙŠØ²)",
            "Ø§ÙŠÙˆÙ†", "Ø§ÙŠ ØªÙˆÙ†ØªÙŠ/Ø§ÙŠ Ø«ÙŠØ±ØªÙŠ (i20/i30)", "Ù…Ø§ØªØ±ÙƒØ³/Ù„Ø§ÙÙŠØªØ§",
            "Ø¨ÙˆØ±ØªØ±", "Ø§ØªÙˆØ³ (Ø§ØªØ³)"
        ],
        "ÙƒÙŠØ§": [
            "Ù…ÙˆØ±Ù†ÙŠÙ‚", "Ø¨ÙŠÙƒØ§Ù†ØªÙˆ", "Ø±ÙŠÙˆ", "Ø³ÙŠØ±Ø§ØªÙˆ", "Ø³ÙˆØ±Ù†ØªÙˆ", "Ø³Ø¨ÙˆØ±ØªØ¬",
            "Ø§ÙˆØ¨ØªÙ…Ø§", "ÙÙŠØ³ØªÙˆ", "Ø£Ù…Ø¬Ø§Ø¯ ÙƒÙŠØ§"
        ],
        "Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ": [
            "Ù„Ø§Ù†Ø³Ø± (Ø¨ÙˆÙ…Ø©/Ù‚Ø±Ø´)", "Ø¨Ø§Ø¬ÙŠØ±Ùˆ", "Ø§ØªØ±Ø§Ø¬", "Ø§ÙˆØªÙ„Ø§Ù†Ø¯Ø±", "Ù…ÙŠØ±Ø§Ø¬",
            "L300 (ÙØ§Ù†/Ø¨ÙˆÙƒØ³ÙŠ)", "ÙƒØ§Ù†ØªØ± (Ø¯ÙØ§Ø±)", "Ø¨ÙƒØ³ Ù…ÙŠØªØ³ÙˆØ¨ÙŠØ´ÙŠ"
        ],
        "Ù†ÙŠØ³Ø§Ù†": [
            "ØµÙ†ÙŠ", "Ø³Ù†ØªØ±Ø§", "ØªÙŠØ¯Ø§", "Ø¨Ø§ØªØ±ÙˆÙ„", "Ù…ÙˆØ±Ø§Ù†Ùˆ", "Ø§ÙƒØ³ ØªØ±ÙŠÙ„ (X-Trail)",
            "Ù„Ø§ÙÙŠÙ†Ø§", "Ø¨ÙŠÙƒ Ø£Ø¨ Ù†ÙŠØ³Ø§Ù†", "Ø¨ÙƒØ³ Ù†ÙŠØ³Ø§Ù†"
        ],
        "Ø³ÙˆØ²ÙˆÙƒÙŠ": [
            "Ø£Ù„ØªÙˆ", "ÙÙŠØªØ§Ø±Ø§", "Ø³ÙˆØ²ÙˆÙƒÙŠ ÙØ§Ù†/ÙƒØ§Ø±ÙŠ (Ø£Ù…Ø¬Ø§Ø¯)"
        ],
        "ÙÙˆÙ„ÙƒØ³ ÙØ§Ø¬Ù†": [
            "Ø¨Ø§Ø³Ø§Øª", "Ø¨ÙˆÙ„Ùˆ", "Ø¨ÙˆØ±Ø§"
        ],
        "Ù‡ÙˆÙ†Ø¯Ø§": [
            "Ø³ÙŠÙÙŠÙƒ", "Ø³ÙŠØªÙŠ"
        ],
        "Ø³ÙƒÙˆØ¯Ø§": [
            "ÙØ§Ø¨ÙŠØ§", "Ø§ÙˆÙƒØªØ§ÙÙŠØ§", "Ø³ÙŠØ¨Ø±ÙŠÙˆØ±"
        ],
        "Ø¨ÙŠ ÙˆØ§ÙŠ Ø¯ÙŠ": [
            "ØµØ§Ù„ÙˆÙ†", "Ø§Ø³ØªÙŠØ´Ù†"
        ],
        "ØªØ§ØªØ§": [
            "Ø¨ÙƒØ³", "Ø¨Øµ", "Ø¯ÙØ§Ø±", "Ø¨ÙˆØ±ØªØ±"
        ],
        "Ù…Ø§Ø±ÙƒØ§Øª Ø£Ø®Ø±Ù‰": [
            "Ù…Ø±Ø³ÙŠØ¯Ø³", "Ø¨ÙŠ Ø§Ù… Ø¯Ø¨Ù„ÙŠÙˆ", "Ø´ÙØ±ÙˆÙ„ÙŠÙ‡", "Ø¬ÙŠÙ„ÙŠ", "Ø§ÙŠØ³ÙˆØ²Ùˆ (Ø¯ÙØ§Ø± Ø§ÙŠØ³ÙˆØ²Ùˆ)",
            "Ù…Ø§Ø²Ø¯Ø§", "Ø§Ù… Ø¬ÙŠ", "Ø¯Ø§ÙŠÙˆ (Ù†ÙˆØ¨ÙŠØ±Ø§/Ø¯Ø§Ù…Ø§Ø³)", "Ø§Ø³ÙƒØ§Ù†ÙŠØ§", "Ø±ÙŠÙ†Ùˆ", "Ø¯Ø§Ù", "Ù‡ÙŠÙ†Ùˆ"
        ]
    };

    const suffixInput = document.getElementById('suffix');
    const typeButtons = document.querySelectorAll('input[name="searchType"]');
    const searchBtn = document.getElementById('searchBtn');
    const spinner = document.getElementById('spinner');
    const helper = document.getElementById('inputHelper');

    const searchCache = new Map();
    const CACHE_DURATION = 60000;

    typeButtons.forEach(btn => {
        btn.addEventListener('change', () => {
            suffixInput.value = "";
            
            if (btn.value === 'chassis') {
                suffixInput.placeholder = "Ø£Ø¯Ø®Ù„ Ø¢Ø®Ø± 4 Ø£Ø±Ù‚Ø§Ù… Ù…Ù† Ø§Ù„Ø´Ø§Ø³ÙŠ";
                suffixInput.maxLength = 4;
                helper.textContent = "âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ 4 Ø£Ø±Ù‚Ø§Ù… Ø¨Ø§Ù„Ø¶Ø¨Ø·";
                helper.style.color = "#d32f2f";
            } else {
                suffixInput.placeholder = "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø© (Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·)";
                suffixInput.maxLength = 10;
                helper.textContent = "ÙŠÙ…ÙƒÙ† Ø¥Ø¯Ø®Ø§Ù„ Ø£ÙŠ Ø¹Ø¯Ø¯ Ù…Ù† Ø§Ù„Ø£Ø±Ù‚Ø§Ù…";
                helper.style.color = "#666";
            }
        });
    });

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙÙˆØ±Ø§Ù‹
    suffixInput.addEventListener('input', (e) => {
        // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·
        suffixInput.value = suffixInput.value.replace(/[^0-9]/g, '');
        
        const isPlate = document.querySelector('input[name="searchType"]:checked').value === 'plate';
        const length = suffixInput.value.length;
        
        if (!isPlate) {
            // Ù„Ù„Ø´Ø§Ø³ÙŠ: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù…
            if (length < 4) {
                helper.textContent = `âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ 4 Ø£Ø±Ù‚Ø§Ù… (ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ ${length})`;
                helper.style.color = "#d32f2f";
                searchBtn.style.opacity = "0.6";
            } else {
                helper.textContent = "âœ… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø­Ø«";
                helper.style.color = "#28a745";
                searchBtn.style.opacity = "1";
            }
        }
    });

    function init() {
        const brandSelect = document.getElementById('brandSelect');
        for (let brand in carData) {
            let opt = document.createElement('option');
            opt.value = brand; 
            opt.innerHTML = brand;
            brandSelect.appendChild(opt);
        }
    }

    function updateModels() {
        const brand = document.getElementById('brandSelect').value;
        const modelSelect = document.getElementById('modelSelect');
        modelSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ --</option>';
        if (brand && carData[brand]) {
            carData[brand].forEach(m => {
                let opt = document.createElement('option');
                opt.value = m; 
                opt.innerHTML = m;
                modelSelect.appendChild(opt);
            });
        }
    }

    async function startSearchOptimized() {
        const brand = document.getElementById('brandSelect').value;
        const model = document.getElementById('modelSelect').value;
        const suffix = suffixInput.value.trim();
        const phone = document.getElementById('phone').value.trim();
        const isPlate = document.querySelector('input[name="searchType"]:checked').value === 'plate';
        const msgDiv = document.getElementById('msg');

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if(!brand || !model || suffix === "" || !phone) { 
            msgDiv.style.display = 'block';
            msgDiv.className = "msg error";
            msgDiv.innerHTML = "âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
            return; 
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ØµØ§Ø±Ù…: Ù„Ù„Ø´Ø§Ø³ÙŠ ÙŠØ¬Ø¨ 4 Ø£Ø±Ù‚Ø§Ù… Ø¨Ø§Ù„Ø¶Ø¨Ø·
        if(!isPlate && suffix.length !== 4) { 
            msgDiv.style.display = 'block';
            msgDiv.className = "msg error";
            msgDiv.innerHTML = `âŒ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ 4 Ø£Ø±Ù‚Ø§Ù… Ù„Ù„Ø´Ø§Ø³ÙŠ Ø¨Ø§Ù„Ø¶Ø¨Ø·<br><small>ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ ${suffix.length} Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·</small>`;
            return; 
        }

        searchBtn.disabled = true;
        spinner.style.display = 'block';
        msgDiv.style.display = 'none';

        const cacheKey = `${suffix}_${isPlate}`;
        const now = Date.now();

        try {
            if (searchCache.has(cacheKey)) {
                const cached = searchCache.get(cacheKey);
                if (now - cached.timestamp < CACHE_DURATION) {
                    await processSearchResult(cached.data, brand, model, suffix, phone, isPlate, msgDiv);
                    searchBtn.disabled = false;
                    spinner.style.display = 'none';
                    return;
                }
            }

            const snapshot = await db.collection('found_cars')
                .where('chassis_suffix', '==', suffix)
                .where('is_plate', '==', isPlate)
                .limit(1)
                .get();

            searchCache.set(cacheKey, {
                data: snapshot,
                timestamp: now
            });

            await processSearchResult(snapshot, brand, model, suffix, phone, isPlate, msgDiv);

        } catch (error) {
            console.error("Search error:", error);
            msgDiv.style.display = 'block';
            msgDiv.className = "msg error";
            msgDiv.innerHTML = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
        } finally {
            searchBtn.disabled = false;
            spinner.style.display = 'none';
        }
    }

    async function processSearchResult(snapshot, brand, model, suffix, phone, isPlate, msgDiv) {
        msgDiv.style.display = 'block';

        if (!snapshot.empty) {
            let foundData = snapshot.docs[0].data();
            msgDiv.className = "msg found";
            msgDiv.innerHTML = `âœ… Ø£Ø¨Ø´Ø±! Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©<br>Ø³Ù†ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ù„ÙƒÙŠØ©<br><small>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø­Ø«: ${suffix}</small>`;
            
            await db.collection('confirmed_matches').add({ 
                brand, 
                model, 
                chassis_suffix: suffix, 
                is_plate: isPlate, 
                owner_phone: phone, 
                finder_phone: foundData.finder_phone, 
                timestamp: firebase.firestore.FieldValue.serverTimestamp() 
            });
        } else {
            msgDiv.className = "msg not-found";
            msgDiv.innerHTML = `ğŸ”” Ù„Ù… ØªØ¸Ù‡Ø± Ø¨Ø¹Ø¯<br>ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ÙˆØ³Ù†Ø®Ø·Ø±Ùƒ ÙÙˆØ± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡Ø§<br><small>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø­Ø«: ${suffix}</small>`;
            
            await db.collection('missing_cars').add({ 
                brand, 
                model, 
                chassis_suffix: suffix, 
                is_plate: isPlate, 
                owner_phone: phone, 
                timestamp: firebase.firestore.FieldValue.serverTimestamp() 
            });
        }
    }

    init();
</script>
</body>
</html>
